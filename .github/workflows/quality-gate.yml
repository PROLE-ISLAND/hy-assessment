# =====================================================
# Quality Gate Workflow (DoD Orchestrator)
# Runs after CI completes on PRs
# Aggregates all quality metrics and posts summary
# =====================================================

name: Quality Gate

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main, develop]

permissions:
  pull-requests: write
  statuses: write
  checks: write

jobs:
  quality-gate:
    name: DoD Quality Gate
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });
            if (pulls.data.length > 0) {
              return pulls.data[0].number;
            }
            return null;

      - name: Download CI artifacts
        if: steps.pr.outputs.result != 'null'
        uses: actions/download-artifact@v7
        with:
          name: nextjs-build
          path: .next
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Check CI status
        id: ci-status
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
            echo "CI passed"
          else
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "CI failed"
          fi

      - name: Determine DoD Level from PR
        id: dod
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Check PR body for DoD level
            const body = pr.body || '';
            let dodLevel = 'Silver'; // default

            if (body.includes('Gold')) {
              dodLevel = 'Gold';
            } else if (body.includes('Bronze')) {
              dodLevel = 'Bronze';
            }

            // Define thresholds
            const thresholds = {
              Bronze: { coverage: 80, quality: 80 },
              Silver: { coverage: 85, quality: 85 },
              Gold: { coverage: 95, quality: 95 }
            };

            return {
              level: dodLevel,
              thresholds: thresholds[dodLevel]
            };

      - name: Generate Quality Report
        id: report
        if: steps.pr.outputs.result != 'null'
        run: |
          # This would typically read from coverage reports
          # For now, create a placeholder
          echo "## Quality Gate Report" > quality-report.md
          echo "" >> quality-report.md
          echo "### CI Status: ${{ steps.ci-status.outputs.status == 'pass' && '✅ Passed' || '❌ Failed' }}" >> quality-report.md
          echo "" >> quality-report.md
          echo "### DoD Level: ${{ fromJSON(steps.dod.outputs.result).level }}" >> quality-report.md
          echo "" >> quality-report.md
          echo "| Check | Status | Threshold |" >> quality-report.md
          echo "|-------|--------|-----------|" >> quality-report.md
          echo "| Lint | ${{ steps.ci-status.outputs.status == 'pass' && '✅' || '❌' }} | Required |" >> quality-report.md
          echo "| Type Check | ${{ steps.ci-status.outputs.status == 'pass' && '✅' || '❌' }} | Required |" >> quality-report.md
          echo "| Unit Tests | ${{ steps.ci-status.outputs.status == 'pass' && '✅' || '❌' }} | Required |" >> quality-report.md
          echo "| Build | ${{ steps.ci-status.outputs.status == 'pass' && '✅' || '❌' }} | Required |" >> quality-report.md
          echo "" >> quality-report.md

          if [ "${{ steps.ci-status.outputs.status }}" == "pass" ]; then
            echo "### Result: ✅ Ready for Review" >> quality-report.md
            echo "gate=pass" >> $GITHUB_OUTPUT
          else
            echo "### Result: ❌ Requires Fixes" >> quality-report.md
            echo "" >> quality-report.md
            echo "> Use \`/devops fix #PR-${{ steps.pr.outputs.result }}\` in Claude Code to auto-fix issues." >> quality-report.md
            echo "gate=fail" >> $GITHUB_OUTPUT
          fi

      - name: Post Quality Report to PR
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = ${{ steps.pr.outputs.result }};
            const report = fs.readFileSync('quality-report.md', 'utf8');

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Quality Gate Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: report
              });
            }

      - name: Update commit status
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ steps.report.outputs.gate }}' === 'pass' ? 'success' : 'failure';
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.workflow_run.head_sha,
              state: state,
              description: state === 'success' ? 'DoD requirements met' : 'DoD requirements not met',
              context: 'Quality Gate / DoD'
            });
