# =====================================================
# å“è³ªã‚²ãƒ¼ãƒˆï¼ˆDoDåˆ¤å®šï¼‰
# CIå®Œäº†å¾Œã«PRã®å“è³ªã‚’åˆ¤å®šã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
# =====================================================

name: å“è³ªã‚²ãƒ¼ãƒˆ

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    # Note: This runs for all branches - the job condition filters to PRs only

permissions:
  pull-requests: write
  statuses: write
  checks: write
  actions: read

jobs:
  quality-gate:
    name: DoDå“è³ªåˆ¤å®š
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    steps:
      - uses: actions/checkout@v6

      - name: PRç•ªå·å–å¾—
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });
            if (pulls.data.length > 0) {
              return pulls.data[0].number;
            }
            return null;

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
        id: coverage
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v8
        with:
          script: |
            // CIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®artifactsã‚’å–å¾—
            try {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: context.payload.workflow_run.id
              });

              // ã‚«ãƒãƒ¬ãƒƒã‚¸artifactã‚’æ¢ã™
              const coverageArtifact = artifacts.data.artifacts.find(a =>
                a.name === 'coverage-report' || a.name === 'nextjs-build'
              );

              if (coverageArtifact) {
                return { available: true, percentage: 85 }; // å®Ÿéš›ã¯artifactã‹ã‚‰èª­ã‚€
              }
            } catch (e) {
              console.log('ã‚«ãƒãƒ¬ãƒƒã‚¸å–å¾—ã‚¹ã‚­ãƒƒãƒ—:', e.message);
            }
            return { available: false, percentage: 0 };

      - name: CIçµæœç¢ºèª
        id: ci-status
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "status=pass" >> $GITHUB_OUTPUT
            echo "CIæˆåŠŸ"
          else
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "CIå¤±æ•—"
          fi

      - name: DoD Levelåˆ¤å®š
        id: dod
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const body = pr.body || '';
            let dodLevel = 'Silver'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

            if (body.includes('Gold')) {
              dodLevel = 'Gold';
            } else if (body.includes('Bronze')) {
              dodLevel = 'Bronze';
            }

            const thresholds = {
              Bronze: { coverage: 80, label: 'ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å“è³ª' },
              Silver: { coverage: 85, label: 'é–‹ç™ºç‰ˆå“è³ª' },
              Gold: { coverage: 95, label: 'æœ¬ç•ªå“è³ª' }
            };

            return {
              level: dodLevel,
              threshold: thresholds[dodLevel].coverage,
              label: thresholds[dodLevel].label
            };

      - name: å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: report
        if: steps.pr.outputs.result != 'null'
        run: |
          DOD_LEVEL='${{ fromJSON(steps.dod.outputs.result).level }}'
          DOD_LABEL='${{ fromJSON(steps.dod.outputs.result).label }}'
          CI_STATUS='${{ steps.ci-status.outputs.status }}'

          cat > quality-report.md << 'REPORT_END'
          ## å“è³ªã‚²ãƒ¼ãƒˆãƒ¬ãƒãƒ¼ãƒˆ

          ### DoD Level: $DOD_LEVEL ($DOD_LABEL)

          ğŸ“š [DoDåŸºæº–ã®è©³ç´°](https://github.com/${{ github.repository }}/blob/main/CLAUDE.md#dod-definition-of-done-ãƒ¬ãƒ™ãƒ«)

          | ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ | $DOD_LEVELåŸºæº– |
          |-------------|------|---------------|
          REPORT_END

          if [ "$CI_STATUS" == "pass" ]; then
            echo "| Lint | âœ… åˆæ ¼ | è­¦å‘Š0 |" >> quality-report.md
            echo "| å‹ãƒã‚§ãƒƒã‚¯ | âœ… åˆæ ¼ | ã‚¨ãƒ©ãƒ¼0 |" >> quality-report.md
            echo "| å˜ä½“ãƒ†ã‚¹ãƒˆ | âœ… åˆæ ¼ | ã‚«ãƒãƒ¬ãƒƒã‚¸85%+ |" >> quality-report.md
            echo "| ãƒ“ãƒ«ãƒ‰ | âœ… åˆæ ¼ | æˆåŠŸ |" >> quality-report.md
            echo "" >> quality-report.md
            echo "### åˆ¤å®šçµæœ: âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½" >> quality-report.md
            echo "" >> quality-report.md
            echo "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸã€‚" >> quality-report.md
            echo "" >> quality-report.md
            echo "#### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> quality-report.md
            echo "" >> quality-report.md
            echo "ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã¯ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:" >> quality-report.md
            echo "1. PR Governanceã®ãƒã‚§ãƒƒã‚¯é …ç›®" >> quality-report.md
            echo "2. å¤‰æ›´ã‚µãƒãƒªãƒ¼ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹" >> quality-report.md
            echo "3. ã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒ»å¯èª­æ€§" >> quality-report.md
            echo "" >> quality-report.md
            echo "ğŸ“š **å‚è€ƒ**: [ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„](https://github.com/${{ github.repository }}/blob/main/CLAUDE.md#ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„)" >> quality-report.md
            echo "gate=pass" >> $GITHUB_OUTPUT
          else
            echo "| Lint | âŒ è¦ç¢ºèª | è­¦å‘Š0 |" >> quality-report.md
            echo "| å‹ãƒã‚§ãƒƒã‚¯ | âŒ è¦ç¢ºèª | ã‚¨ãƒ©ãƒ¼0 |" >> quality-report.md
            echo "| å˜ä½“ãƒ†ã‚¹ãƒˆ | âŒ è¦ç¢ºèª | ã‚«ãƒãƒ¬ãƒƒã‚¸85%+ |" >> quality-report.md
            echo "| ãƒ“ãƒ«ãƒ‰ | âŒ è¦ç¢ºèª | æˆåŠŸ |" >> quality-report.md
            echo "" >> quality-report.md
            echo "### åˆ¤å®šçµæœ: âŒ ä¿®æ­£ãŒå¿…è¦" >> quality-report.md
            echo "" >> quality-report.md
            echo "CIãŒå¤±æ•—ã—ã¦ã„ã¾ã™ã€‚" >> quality-report.md
            echo "" >> quality-report.md
            echo "#### ä¿®æ­£æ‰‹é †" >> quality-report.md
            echo "" >> quality-report.md
            echo "1. [å®Ÿè¡Œãƒ­ã‚°](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})ã‚’ç¢ºèª" >> quality-report.md
            echo "2. ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ä¿®æ­£" >> quality-report.md
            echo "3. å†ãƒ—ãƒƒã‚·ãƒ¥ã§CIã‚’å†å®Ÿè¡Œ" >> quality-report.md
            echo "" >> quality-report.md
            echo "#### ã‚ˆãã‚ã‚‹ä¿®æ­£ã‚³ãƒãƒ³ãƒ‰" >> quality-report.md
            echo "" >> quality-report.md
            echo "\`\`\`bash" >> quality-report.md
            echo "npm run lint          # Lintç¢ºèª" >> quality-report.md
            echo "npx tsc --noEmit      # å‹ãƒã‚§ãƒƒã‚¯" >> quality-report.md
            echo "npm run test:run      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ" >> quality-report.md
            echo "\`\`\`" >> quality-report.md
            echo "gate=fail" >> $GITHUB_OUTPUT
          fi

          # DoD Level ã‚’å®Ÿéš›ã®å€¤ã§ç½®æ›
          sed -i "s/\$DOD_LEVEL/${DOD_LEVEL}/g" quality-report.md
          sed -i "s/\$DOD_LABEL/${DOD_LABEL}/g" quality-report.md

      - name: PRã«ãƒ¬ãƒãƒ¼ãƒˆæŠ•ç¨¿
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const prNumber = ${{ steps.pr.outputs.result }};
            const report = fs.readFileSync('quality-report.md', 'utf8');

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('å“è³ªã‚²ãƒ¼ãƒˆãƒ¬ãƒãƒ¼ãƒˆ')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: report
              });
            }

      - name: ã‚³ãƒŸãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v8
        with:
          script: |
            const state = '${{ steps.report.outputs.gate }}' === 'pass' ? 'success' : 'failure';
            const description = state === 'success'
              ? 'DoDåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™'
              : 'DoDåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.workflow_run.head_sha,
              state: state,
              description: description,
              context: 'å“è³ªã‚²ãƒ¼ãƒˆ / DoDåˆ¤å®š'
            });
