# =====================================================
# PR Governance
# Whyå¿…é ˆãƒã‚§ãƒƒã‚¯ãƒ»ãƒ–ãƒ©ãƒ³ãƒè¦ç´„ãƒ»è‡ªå‹•ãƒ©ãƒ™ãƒªãƒ³ã‚°ãƒ»å¤‰æ›´ã‚µãƒãƒªãƒ¼
# pr-check.yml ã®æ©Ÿèƒ½ã‚’çµ±åˆæ¸ˆã¿
# =====================================================

name: ğŸ›¡ï¸ PR Governance

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-quality-gate:
    name: ğŸ“‹ PR Quality Gate
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v6

    - name: ğŸ” Check PR Description Quality
      uses: actions/github-script@v8
      with:
        script: |
          const prBody = context.payload.pull_request.body || '';
          const prTitle = context.payload.pull_request.title || '';
          const branchName = context.payload.pull_request.head.ref;
          const issues = [];
          const warnings = [];

          // === ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ ===
          const validBranchPatterns = [
            /^feature\/issue-\d+-/,
            /^bugfix\/issue-\d+-/,
            /^hotfix\/issue-\d+-/,
            /^chore\//,
            /^fix\//,
            /^docs\//,
            /^ci\//,
            /^deps\//,
            /^dependabot\//,
            /^renovate\//,
          ];
          const isValidBranch = validBranchPatterns.some(p => p.test(branchName));
          if (!isValidBranch) {
            warnings.push(`âš ï¸ **ãƒ–ãƒ©ãƒ³ãƒåãŒè¦ç´„å¤–ã§ã™**: \`${branchName}\`\n   â†’ æ¨å¥¨: \`feature/issue-{ç•ªå·}-{èª¬æ˜}\` å½¢å¼`);
          }

          // === WHY ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ ===
          // ãƒ˜ãƒƒãƒ€ãƒ¼å¾Œã«çµµæ–‡å­—ã‚„ã€Œå¿…é ˆã€ãŒã‚ã£ã¦ã‚‚ãƒãƒƒãƒã€æ”¹è¡Œ1ã¤ã§ã‚‚OK
          const whySection = prBody.match(/## 2\.?\s*å¤‰æ›´ç†ç”±ï¼ˆWhyï¼‰[^\n]*\n+([\s\S]*?)(?=\n## |\n---|\Z)/);
          const whyContent = whySection ? whySection[1].trim() : '';

          // ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’é™¤å»ã—ã¦å®Ÿéš›ã®å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯
          const whyClean = whyContent.replace(/<!--[\s\S]*?-->/g, '').trim();

          if (!whyClean || whyClean.length < 10) {
            issues.push('âŒ **å¤‰æ›´ç†ç”±ï¼ˆWhyï¼‰ãŒæœªè¨˜å…¥ã§ã™**\n   â†’ ãªãœã“ã®å¤‰æ›´ãŒå¿…è¦ãªã®ã‹è¨˜è¼‰ã—ã¦ãã ã•ã„');
          }

          // === ç›®çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ ===
          // ãƒ˜ãƒƒãƒ€ãƒ¼å¾Œã«çµµæ–‡å­—ãŒã‚ã£ã¦ã‚‚ãƒãƒƒãƒã€æ”¹è¡Œ1ã¤ã§ã‚‚OK
          const whatSection = prBody.match(/## 1\.?\s*ç›®çš„ï¼ˆWhatï¼‰[^\n]*\n+([\s\S]*?)(?=\n## |\Z)/);
          const whatContent = whatSection ? whatSection[1].replace(/<!--[\s\S]*?-->/g, '').trim() : '';

          if (!whatContent || whatContent.length < 5) {
            warnings.push('âš ï¸ **ç›®çš„ï¼ˆWhatï¼‰ãŒæœªè¨˜å…¥ã§ã™**');
          }

          // === ãƒªã‚¹ã‚¯è©•ä¾¡ãƒã‚§ãƒƒã‚¯ ===
          // ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã«Low/Med/HighãŒã‚ã‚Œã°ãƒãƒƒãƒï¼ˆã‚¹ãƒšãƒ¼ã‚¹è¨±å®¹ï¼‰
          const riskFilled = prBody.match(/\|\s*(Low|Med|High)\s*\|/i);
          if (!riskFilled) {
            warnings.push('âš ï¸ **ãƒªã‚¹ã‚¯è©•ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæœªè¨˜å…¥ã§ã™**ï¼ˆLow / Med / High ã‚’è¨˜å…¥ï¼‰');
          }

          // === é–¢é€£Issueãƒã‚§ãƒƒã‚¯ ===
          const hasIssueRef = prBody.match(/#\d+/) || prBody.match(/Closes|Fixes|Relates/i);
          if (!hasIssueRef) {
            warnings.push('âš ï¸ **é–¢é€£Issueã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã›ã‚“**');
          }

          // === ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèª ===
          const whyChecked = prBody.includes('[x] **Whyï¼ˆå¤‰æ›´ç†ç”±ï¼‰ã‚’è¨˜è¼‰ã—ãŸ**');
          if (!whyChecked && whyClean.length >= 10) {
            warnings.push('âš ï¸ **ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ã€ŒWhyè¨˜è¼‰ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„**');
          }

          // === çµæœå‡ºåŠ› ===
          let comment = '## ğŸ›¡ï¸ PR Governance Check\n\n';

          if (issues.length > 0) {
            comment += '### âŒ å¿…é ˆé …ç›®ã®ä¸å‚™\n\n';
            comment += issues.join('\n\n') + '\n\n';
            comment += '> **ã“ã®PRã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡å¤–ã§ã™ã€‚ä¸Šè¨˜ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚**\n\n';
          }

          if (warnings.length > 0) {
            comment += '### âš ï¸ æ¨å¥¨äº‹é …\n\n';
            comment += warnings.join('\n') + '\n\n';
          }

          if (issues.length === 0 && warnings.length === 0) {
            comment += '### âœ… All checks passed!\n\n';
            comment += 'PR descriptionãŒé©åˆ‡ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ã§ã™ã€‚';
          } else if (issues.length === 0) {
            comment += '### âœ… å¿…é ˆé …ç›®OK\n\n';
            comment += 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ã§ã™ãŒã€ä¸Šè¨˜ã®æ¨å¥¨äº‹é …ã®å¯¾å¿œã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚';
          }

          // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆ
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(c =>
            c.user.type === 'Bot' && c.body.includes('PR Governance Check')
          );

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

          // å¿…é ˆé …ç›®ä¸å‚™ãŒã‚ã‚Œã°å¤±æ•—
          if (issues.length > 0) {
            core.setFailed('PR description is incomplete. Please fill in the required sections.');
          }

  auto-labeler:
    name: ğŸ·ï¸ Auto Label
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ Add Labels Based on Files
      uses: actions/github-script@v8
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });

          const labels = new Set();

          for (const file of files) {
            const path = file.filename;

            // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
            if (path.startsWith('src/components/') || path.includes('.tsx') || path.includes('.jsx')) {
              labels.add('frontend');
            }

            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰/API
            if (path.startsWith('src/app/api/') || path.startsWith('api/')) {
              labels.add('backend');
            }

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
            if (path.includes('supabase') || path.includes('migration') || path.includes('schema')) {
              labels.add('database');
            }

            // ã‚¤ãƒ³ãƒ•ãƒ©/CI
            if (path.startsWith('.github/') || path.includes('docker') || path.includes('vercel')) {
              labels.add('infrastructure');
            }

            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
            if (path.endsWith('.md') || path.startsWith('docs/')) {
              labels.add('documentation');
            }

            // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
            if (path.includes('config') || path.endsWith('.yml') || path.endsWith('.yaml') || path.endsWith('.json')) {
              labels.add('config');
            }

            // ãƒ†ã‚¹ãƒˆ
            if (path.includes('test') || path.includes('spec') || path.startsWith('e2e/')) {
              labels.add('tests');
            }

            // UI/ãƒ‡ã‚¶ã‚¤ãƒ³
            if (path.includes('design-system') || path.includes('.css')) {
              labels.add('ui');
            }

            // AIåˆ†æ
            if (path.includes('analysis') || path.includes('ai-')) {
              labels.add('ai');
            }
          }

          // ã‚µã‚¤ã‚ºãƒ©ãƒ™ãƒ«
          const totalChanges = files.reduce((sum, f) => sum + f.changes, 0);
          if (totalChanges > 500) {
            labels.add('size/large');
          } else if (totalChanges > 100) {
            labels.add('size/medium');
          } else {
            labels.add('size/small');
          }

          if (labels.size > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: Array.from(labels)
            });
          }

  file-change-summary:
    name: ğŸ“Š Change Summary
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: ğŸ“Š Generate Change Summary
      uses: actions/github-script@v8
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });

          // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ¥ã®å¤‰æ›´é›†è¨ˆ
          const dirChanges = {};
          let totalAdditions = 0;
          let totalDeletions = 0;

          for (const file of files) {
            const dir = file.filename.split('/').slice(0, 2).join('/') || file.filename;
            if (!dirChanges[dir]) {
              dirChanges[dir] = { files: 0, additions: 0, deletions: 0 };
            }
            dirChanges[dir].files++;
            dirChanges[dir].additions += file.additions;
            dirChanges[dir].deletions += file.deletions;
            totalAdditions += file.additions;
            totalDeletions += file.deletions;
          }

          // ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
          let summary = '## ğŸ“Š å¤‰æ›´ã‚µãƒãƒªãƒ¼\n\n';
          summary += `**åˆè¨ˆ**: ${files.length}ãƒ•ã‚¡ã‚¤ãƒ« (+${totalAdditions} -${totalDeletions})\n\n`;
          summary += '| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | ãƒ•ã‚¡ã‚¤ãƒ«æ•° | è¿½åŠ  | å‰Šé™¤ |\n';
          summary += '|-------------|-----------|------|------|\n';

          for (const [dir, stats] of Object.entries(dirChanges).sort((a, b) => b[1].files - a[1].files)) {
            summary += `| \`${dir}\` | ${stats.files} | +${stats.additions} | -${stats.deletions} |\n`;
          }

          // ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ã‚’è¿½åŠ 
          summary += '\n### ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹\n\n';

          if (Object.keys(dirChanges).some(d => d.includes('api'))) {
            summary += '- [ ] APIå¤‰æ›´: ç ´å£Šçš„å¤‰æ›´ãŒãªã„ã‹ç¢ºèª\n';
          }
          if (Object.keys(dirChanges).some(d => d.includes('supabase') || d.includes('migration'))) {
            summary += '- [ ] DBå¤‰æ›´: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®‰å…¨æ€§ã‚’ç¢ºèª\n';
          }
          if (Object.keys(dirChanges).some(d => d.includes('config'))) {
            summary += '- [ ] è¨­å®šå¤‰æ›´: ç’°å¢ƒä¾å­˜ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºèª\n';
          }
          if (Object.keys(dirChanges).some(d => d.includes('analysis'))) {
            summary += '- [ ] AIåˆ†æ: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®æ•´åˆæ€§ã‚’ç¢ºèª\n';
          }
          if (totalAdditions + totalDeletions > 300) {
            summary += '- [ ] å¤§è¦æ¨¡å¤‰æ›´: æ®µéšçš„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¨å¥¨\n';
          }

          console.log(summary);

          // PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆé‡è¤‡å›é¿ï¼‰
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const existingSummary = comments.find(c =>
            c.user.type === 'Bot' && c.body.includes('å¤‰æ›´ã‚µãƒãƒªãƒ¼')
          );

          if (existingSummary) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingSummary.id,
              body: summary
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
          }
