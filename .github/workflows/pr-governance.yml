# =====================================================
# PR Governance
# Whyå¿…é ˆãƒã‚§ãƒƒã‚¯ãƒ»ãƒ–ãƒ©ãƒ³ãƒè¦ç´„ãƒ»è‡ªå‹•ãƒ©ãƒ™ãƒªãƒ³ã‚°ãƒ»å¤‰æ›´ã‚µãƒãƒªãƒ¼
# pr-check.yml ã®æ©Ÿèƒ½ã‚’çµ±åˆæ¸ˆã¿
# =====================================================

name: ğŸ›¡ï¸ PR Governance

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-quality-gate:
    name: ğŸ“‹ PR Quality Gate
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v6

    - name: ğŸ” Check PR Description Quality
      uses: actions/github-script@v8
      with:
        script: |
          const prBody = context.payload.pull_request.body || '';
          const prTitle = context.payload.pull_request.title || '';
          const branchName = context.payload.pull_request.head.ref;
          const issues = [];
          const warnings = [];

          // === ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ ===
          // Issueç•ªå·å¿…é ˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ©Ÿèƒ½é–‹ç™ºãƒ»ãƒã‚°ä¿®æ­£ï¼‰
          const issueRequiredPatterns = [
            /^feature\/issue-\d+-/,
            /^bugfix\/issue-\d+-/,
            /^hotfix\/issue-\d+-/,
          ];
          // Issueç•ªå·ä¸è¦ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ç³»ï¼‰
          const maintenancePatterns = [
            /^chore\//,
            /^fix\//,
            /^docs\//,
            /^ci\//,
            /^deps\//,
            /^dependabot\//,
            /^renovate\//,
          ];

          const hasIssueNumber = issueRequiredPatterns.some(p => p.test(branchName));
          const isMaintenance = maintenancePatterns.some(p => p.test(branchName));

          if (!hasIssueNumber && !isMaintenance) {
            // æ©Ÿèƒ½é–‹ç™ºã£ã½ã„ã®ã«Issueç•ªå·ãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
            if (branchName.startsWith('feature/') || branchName.startsWith('bugfix/') || branchName.startsWith('hotfix/')) {
              issues.push(`âŒ **ãƒ–ãƒ©ãƒ³ãƒåã«Issueç•ªå·ãŒã‚ã‚Šã¾ã›ã‚“**: \`${branchName}\`\n\nå¿…é ˆå½¢å¼: \`feature/issue-{ç•ªå·}-{èª¬æ˜}\`\n\nä¾‹: \`feature/issue-123-add-pagination\`\n\nğŸ“‹ [Issueä¸€è¦§](https://github.com/${context.repo.owner}/${context.repo.repo}/issues)`);
            } else {
              issues.push(`âŒ **ãƒ–ãƒ©ãƒ³ãƒåãŒè¦ç´„å¤–ã§ã™**: \`${branchName}\`\n\nè¨±å¯ã•ã‚Œã‚‹ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹:\n- \`feature/issue-{ç•ªå·}-\` (æ©Ÿèƒ½è¿½åŠ )\n- \`bugfix/issue-{ç•ªå·}-\` (ãƒã‚°ä¿®æ­£)\n- \`hotfix/issue-{ç•ªå·}-\` (ç·Šæ€¥ä¿®æ­£)\n- \`chore/\`, \`docs/\`, \`ci/\`, \`deps/\` (ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹)\n\nğŸ“š [é–‹ç™ºãƒ«ãƒ¼ãƒ«](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CLAUDE.md)`);
            }
          }

          // === WHY ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ ===
          // ãƒ˜ãƒƒãƒ€ãƒ¼å¾Œã«çµµæ–‡å­—ã‚„ã€Œå¿…é ˆã€ãŒã‚ã£ã¦ã‚‚ãƒãƒƒãƒã€æ”¹è¡Œ1ã¤ã§ã‚‚OK
          const whySection = prBody.match(/## 2\.?\s*å¤‰æ›´ç†ç”±ï¼ˆWhyï¼‰[^\n]*\n+([\s\S]*?)(?=\n## |\n---|\Z)/);
          const whyContent = whySection ? whySection[1].trim() : '';

          // ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’é™¤å»ã—ã¦å®Ÿéš›ã®å†…å®¹ã‚’ãƒã‚§ãƒƒã‚¯
          const whyClean = whyContent.replace(/<!--[\s\S]*?-->/g, '').trim();

          if (!whyClean || whyClean.length < 10) {
            issues.push('âŒ **å¤‰æ›´ç†ç”±ï¼ˆWhyï¼‰ãŒæœªè¨˜å…¥ã§ã™**\n\n#### ä½•ã‚’æ›¸ã‘ã°ã„ã„ã‹\n- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾¡å€¤**: ã“ã®å¤‰æ›´ã§èª°ãŒã©ã†å¬‰ã—ã„ã‹\n- **æŠ€è¡“çš„èƒŒæ™¯**: ãªãœä»Šã“ã®å¤‰æ›´ãŒå¿…è¦ã‹\n- **ä»£æ›¿æ¡ˆã®æ¤œè¨**: ä»–ã®æ–¹æ³•ã‚’è€ƒãˆãŸã‹\n\n#### è‰¯ã„Whyã®ä¾‹\n> ã€Œå€™è£œè€…ä¸€è¦§ã®èª­ã¿è¾¼ã¿ãŒ3ç§’ä»¥ä¸Šã‹ã‹ã‚Šæ”¹å–„è¦æœ›ãŒã‚ã£ãŸã€‚N+1è§£æ¶ˆã¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ã§200msä»¥ä¸‹ã‚’ç›®æŒ‡ã™ã€‚ã€\n\nğŸ“š **å‚è€ƒ**: [PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/.github/PULL_REQUEST_TEMPLATE.md) | [é–‹ç™ºã‚¬ã‚¤ãƒ‰](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/CLAUDE.md#é–‹ç™ºãƒ•ãƒ­ãƒ¼)');
          }

          // === ç›®çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ ===
          // ãƒ˜ãƒƒãƒ€ãƒ¼å¾Œã«çµµæ–‡å­—ãŒã‚ã£ã¦ã‚‚ãƒãƒƒãƒã€æ”¹è¡Œ1ã¤ã§ã‚‚OK
          const whatSection = prBody.match(/## 1\.?\s*ç›®çš„ï¼ˆWhatï¼‰[^\n]*\n+([\s\S]*?)(?=\n## |\Z)/);
          const whatContent = whatSection ? whatSection[1].replace(/<!--[\s\S]*?-->/g, '').trim() : '';

          if (!whatContent || whatContent.length < 5) {
            warnings.push('âš ï¸ **ç›®çš„ï¼ˆWhatï¼‰ãŒæœªè¨˜å…¥ã§ã™**\n   â†’ ã€Œä½•ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€ã‚’1-2æ–‡ã§ç°¡æ½”ã«è¨˜è¼‰ã—ã¦ãã ã•ã„\n   ğŸ’¡ ä¾‹: ã€Œå€™è£œè€…ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã€');
          }

          // === ãƒªã‚¹ã‚¯è©•ä¾¡ãƒã‚§ãƒƒã‚¯ ===
          // ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã«Low/Med/HighãŒã‚ã‚Œã°ãƒãƒƒãƒï¼ˆã‚¹ãƒšãƒ¼ã‚¹è¨±å®¹ï¼‰
          const riskFilled = prBody.match(/\|\s*(Low|Med|High)\s*\|/i);
          if (!riskFilled) {
            warnings.push('âš ï¸ **ãƒªã‚¹ã‚¯è©•ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæœªè¨˜å…¥ã§ã™**\n   â†’ å„ã‚«ãƒ†ã‚´ãƒªã« Low / Med / High ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„\n   ğŸ“Š ãƒªã‚¹ã‚¯ç›®å®‰: Low=å½±éŸ¿å°, Med=ä¸€éƒ¨æ©Ÿèƒ½ã«å½±éŸ¿, High=å…¨ä½“ã«å½±éŸ¿');
          }

          // === é–¢é€£Issueãƒã‚§ãƒƒã‚¯ ===
          const hasIssueRef = prBody.match(/#\d+/) || prBody.match(/Closes|Fixes|Relates/i);
          if (!hasIssueRef) {
            warnings.push('âš ï¸ **é–¢é€£Issueã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã›ã‚“**\n   â†’ `closes #123` ã¾ãŸã¯ `Relates to #123` å½¢å¼ã§é–¢é€£Issueã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„\n   ğŸ“‹ [Issueä¸€è¦§](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/issues)');
          }

          // === ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèª ===
          const whyChecked = prBody.includes('[x] **Whyï¼ˆå¤‰æ›´ç†ç”±ï¼‰ã‚’è¨˜è¼‰ã—ãŸ**');
          if (!whyChecked && whyClean.length >= 10) {
            warnings.push('âš ï¸ **ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ã€ŒWhyè¨˜è¼‰ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„**');
          }

          // === çµæœå‡ºåŠ› ===
          let comment = '## ğŸ›¡ï¸ PR Governance Check\n\n';

          if (issues.length > 0) {
            comment += '### âŒ å¿…é ˆé …ç›®ã®ä¸å‚™\n\n';
            comment += issues.join('\n\n') + '\n\n';
            comment += '> **ã“ã®PRã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡å¤–ã§ã™ã€‚ä¸Šè¨˜ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚**\n\n';
          }

          if (warnings.length > 0) {
            comment += '### âš ï¸ æ¨å¥¨äº‹é …\n\n';
            comment += warnings.join('\n') + '\n\n';
          }

          if (issues.length === 0 && warnings.length === 0) {
            comment += '### âœ… All checks passed!\n\n';
            comment += 'PR descriptionãŒé©åˆ‡ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ã§ã™ã€‚\n\n';
            comment += 'ğŸ“š **ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã¸**: [ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/CLAUDE.md#ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚';
          } else if (issues.length === 0) {
            comment += '### âœ… å¿…é ˆé …ç›®OK\n\n';
            comment += 'ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ã§ã™ãŒã€ä¸Šè¨˜ã®æ¨å¥¨äº‹é …ã®å¯¾å¿œã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚\n\n';
            comment += 'ğŸ“š **å‚è€ƒ**: [PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/.github/PULL_REQUEST_TEMPLATE.md)';
          }

          // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã¾ãŸã¯æ–°è¦ä½œæˆ
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(c =>
            c.user.type === 'Bot' && c.body.includes('PR Governance Check')
          );

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

          // å¿…é ˆé …ç›®ä¸å‚™ãŒã‚ã‚Œã°å¤±æ•—
          if (issues.length > 0) {
            core.setFailed('PR description is incomplete. Please fill in the required sections.');
          }

  auto-labeler:
    name: ğŸ·ï¸ Auto Label
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ Add Labels Based on Files
      uses: actions/github-script@v8
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });

          const labels = new Set();

          for (const file of files) {
            const path = file.filename;

            // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
            if (path.startsWith('src/components/') || path.includes('.tsx') || path.includes('.jsx')) {
              labels.add('frontend');
            }

            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰/API
            if (path.startsWith('src/app/api/') || path.startsWith('api/')) {
              labels.add('backend');
            }

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
            if (path.includes('supabase') || path.includes('migration') || path.includes('schema')) {
              labels.add('database');
            }

            // ã‚¤ãƒ³ãƒ•ãƒ©/CI
            if (path.startsWith('.github/') || path.includes('docker') || path.includes('vercel')) {
              labels.add('infrastructure');
            }

            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
            if (path.endsWith('.md') || path.startsWith('docs/')) {
              labels.add('documentation');
            }

            // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
            if (path.includes('config') || path.endsWith('.yml') || path.endsWith('.yaml') || path.endsWith('.json')) {
              labels.add('config');
            }

            // ãƒ†ã‚¹ãƒˆ
            if (path.includes('test') || path.includes('spec') || path.startsWith('e2e/')) {
              labels.add('tests');
            }

            // UI/ãƒ‡ã‚¶ã‚¤ãƒ³
            if (path.includes('design-system') || path.includes('.css')) {
              labels.add('ui');
            }

            // AIåˆ†æ
            if (path.includes('analysis') || path.includes('ai-')) {
              labels.add('ai');
            }
          }

          // ã‚µã‚¤ã‚ºãƒ©ãƒ™ãƒ«
          const totalChanges = files.reduce((sum, f) => sum + f.changes, 0);
          if (totalChanges > 500) {
            labels.add('size/large');
          } else if (totalChanges > 100) {
            labels.add('size/medium');
          } else {
            labels.add('size/small');
          }

          if (labels.size > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: Array.from(labels)
            });
          }

  file-change-summary:
    name: ğŸ“Š Change Summary
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: ğŸ“Š Generate Change Summary
      uses: actions/github-script@v8
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });

          // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ¥ã®å¤‰æ›´é›†è¨ˆ
          const dirChanges = {};
          let totalAdditions = 0;
          let totalDeletions = 0;

          for (const file of files) {
            const dir = file.filename.split('/').slice(0, 2).join('/') || file.filename;
            if (!dirChanges[dir]) {
              dirChanges[dir] = { files: 0, additions: 0, deletions: 0 };
            }
            dirChanges[dir].files++;
            dirChanges[dir].additions += file.additions;
            dirChanges[dir].deletions += file.deletions;
            totalAdditions += file.additions;
            totalDeletions += file.deletions;
          }

          // ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
          let summary = '## ğŸ“Š å¤‰æ›´ã‚µãƒãƒªãƒ¼\n\n';
          summary += `**åˆè¨ˆ**: ${files.length}ãƒ•ã‚¡ã‚¤ãƒ« (+${totalAdditions} -${totalDeletions})\n\n`;
          summary += '| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | ãƒ•ã‚¡ã‚¤ãƒ«æ•° | è¿½åŠ  | å‰Šé™¤ |\n';
          summary += '|-------------|-----------|------|------|\n';

          for (const [dir, stats] of Object.entries(dirChanges).sort((a, b) => b[1].files - a[1].files)) {
            summary += `| \`${dir}\` | ${stats.files} | +${stats.additions} | -${stats.deletions} |\n`;
          }

          // ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ã‚’è¿½åŠ 
          summary += '\n### ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹\n\n';

          const hasApiChanges = Object.keys(dirChanges).some(d => d.includes('api'));
          const hasDbChanges = Object.keys(dirChanges).some(d => d.includes('supabase') || d.includes('migration'));
          const hasConfigChanges = Object.keys(dirChanges).some(d => d.includes('config'));
          const hasAnalysisChanges = Object.keys(dirChanges).some(d => d.includes('analysis'));
          const isLargeChange = totalAdditions + totalDeletions > 300;

          if (hasApiChanges) {
            summary += '#### APIå¤‰æ›´ (`src/app/api/`)\n';
            summary += '- [ ] **ç ´å£Šçš„å¤‰æ›´ãƒã‚§ãƒƒã‚¯**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹å¤‰æ›´ã€å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ ã¯ãªã„ã‹\n';
            summary += '- [ ] **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã—ã¦ã„ã‚‹ã‹\n';
            summary += '- ğŸ“š [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/CLAUDE.md#æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)\n\n';
          }
          if (hasDbChanges) {
            summary += '#### DBå¤‰æ›´ (`supabase/`)\n';
            summary += '- [ ] **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®‰å…¨æ€§**: `DROP`/`ALTER`ã¯æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ã—ãªã„ã‹\n';
            summary += '- [ ] **RLSãƒãƒªã‚·ãƒ¼**: organization_idåˆ†é›¢ãŒç¶­æŒã•ã‚Œã¦ã„ã‚‹ã‹\n';
            summary += '- [ ] **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½**: down migrationãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‹\n';
            summary += '- ğŸ“š [DBè¨­è¨ˆãƒ«ãƒ¼ãƒ«](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/CLAUDE.md#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)\n\n';
          }
          if (hasConfigChanges) {
            summary += '#### è¨­å®šå¤‰æ›´\n';
            summary += '- [ ] **ç’°å¢ƒä¾å­˜**: æœ¬ç•ª/ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°/ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ä½œã™ã‚‹ã‹\n';
            summary += '- [ ] **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: æ©Ÿå¯†æƒ…å ±ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã‹\n\n';
          }
          if (hasAnalysisChanges) {
            summary += '#### AIåˆ†æå¤‰æ›´\n';
            summary += '- [ ] **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ•´åˆæ€§**: æœŸå¾…ã™ã‚‹å‡ºåŠ›å½¢å¼ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹\n';
            summary += '- [ ] **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: APIå¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒã‚ã‚‹ã‹\n\n';
          }
          if (isLargeChange) {
            summary += '#### âš ï¸ å¤§è¦æ¨¡å¤‰æ›´ (' + (totalAdditions + totalDeletions) + 'è¡Œ)\n';
            summary += '- [ ] **åˆ†å‰²æ¤œè¨**: ã“ã®PRã‚’è¤‡æ•°ã«åˆ†ã‘ã‚‰ã‚Œãªã„ã‹\n';
            summary += '- [ ] **æ®µéšçš„ãƒ¬ãƒ“ãƒ¥ãƒ¼**: é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é †ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼\n';
            summary += '- ğŸ’¡ æ¨å¥¨: 1PR = 200è¡Œä»¥ä¸‹\n\n';
          }
          if (!hasApiChanges && !hasDbChanges && !hasConfigChanges && !hasAnalysisChanges && !isLargeChange) {
            summary += 'ç‰¹ã«æ³¨æ„ãŒå¿…è¦ãªå¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚é€šå¸¸ã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚\n';
          }

          console.log(summary);

          // PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆé‡è¤‡å›é¿ï¼‰
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const existingSummary = comments.find(c =>
            c.user.type === 'Bot' && c.body.includes('å¤‰æ›´ã‚µãƒãƒªãƒ¼')
          );

          if (existingSummary) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingSummary.id,
              body: summary
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
          }

  variant-check:
    name: ğŸ¨ Variant Check
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: ğŸ¨ Check UI Component Variants
      uses: actions/github-script@v8
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });

          const fs = require('fs');
          const path = require('path');

          // å¯¾è±¡: src/components/ é…ä¸‹ã®æ–°è¦ .tsx ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆui/ ã¯é™¤å¤–ï¼‰
          const newComponentFiles = files.filter(f =>
            f.status === 'added' &&
            f.filename.endsWith('.tsx') &&
            f.filename.startsWith('src/components/') &&
            !f.filename.startsWith('src/components/ui/') &&
            !f.filename.includes('/shared') &&
            !f.filename.includes('/index')
          );

          if (newComponentFiles.length === 0) {
            console.log('No new UI components detected. Skipping variant check.');
            return;
          }

          const issues = [];
          const warnings = [];

          for (const file of newComponentFiles) {
            try {
              const content = fs.readFileSync(file.filename, 'utf8');

              // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåã‚’æ¨å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ï¼‰
              const componentName = path.basename(file.filename, '.tsx');

              // data-testid ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
              const testIdPattern = /data-testid=["'`]([^"'`]+)["'`]/g;
              const foundTestIds = [];
              let match;
              while ((match = testIdPattern.exec(content)) !== null) {
                foundTestIds.push(match[1]);
              }

              // ã‚±ãƒãƒ–ã‚±ãƒ¼ã‚¹å¤‰æ›ï¼ˆBehavioralAnalysisCard â†’ behavioral-analysis-cardï¼‰
              const kebabName = componentName
                .replace(/([a-z])([A-Z])/g, '$1-$2')
                .toLowerCase();

              // å¿…é ˆãƒãƒªã‚¢ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
              const requiredVariants = [
                { suffix: '', name: 'Default' },
                { suffix: '-skeleton', name: 'Loading' },
                { suffix: '-empty', name: 'Empty' },
                { suffix: '-error', name: 'Error' }
              ];

              const missingVariants = [];
              for (const variant of requiredVariants) {
                const expectedTestId = kebabName + variant.suffix;
                const hasVariant = foundTestIds.some(id =>
                  id === expectedTestId ||
                  id.includes(expectedTestId) ||
                  (variant.suffix === '' && id === kebabName)
                );

                if (!hasVariant) {
                  missingVariants.push(`\`${expectedTestId}\` (${variant.name})`);
                }
              }

              if (missingVariants.length > 0) {
                // 4ã¤å…¨éƒ¨ãªã„å ´åˆã¯è­¦å‘Šã®ã¿ï¼ˆãƒãƒªã‚¢ãƒ³ãƒˆä¸è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¯èƒ½æ€§ï¼‰
                if (missingVariants.length === 4) {
                  warnings.push(`âš ï¸ **${file.filename}**\n   data-testidãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒãƒªã‚¢ãƒ³ãƒˆå¯¾å¿œãŒå¿…è¦ãªå ´åˆã¯è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
                } else {
                  // ä¸€éƒ¨ã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ï¼ˆãƒãƒªã‚¢ãƒ³ãƒˆå¯¾å¿œä¸­ã ãŒä¸å®Œå…¨ï¼‰
                  issues.push(`âŒ **${file.filename}**\n   ä¸è¶³ãƒãƒªã‚¢ãƒ³ãƒˆ: ${missingVariants.join(', ')}`);
                }
              }
            } catch (e) {
              console.log(`Could not read file: ${file.filename}`);
            }
          }

          // çµæœå‡ºåŠ›
          if (issues.length === 0 && warnings.length === 0) {
            console.log('All new components have proper variant data-testids.');
            return;
          }

          let comment = '## ğŸ¨ Variant Check\n\n';

          if (issues.length > 0) {
            comment += '### âŒ ãƒãƒªã‚¢ãƒ³ãƒˆä¸è¶³\n\n';
            comment += 'ä»¥ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å¿…é ˆãƒãƒªã‚¢ãƒ³ãƒˆã® data-testid ãŒä¸è¶³ã—ã¦ã„ã¾ã™:\n\n';
            comment += issues.join('\n') + '\n\n';
            comment += 'ğŸ“š **å¿…é ˆãƒãƒªã‚¢ãƒ³ãƒˆ**: Default, Loading (skeleton), Empty, Error\n\n';
            comment += '```tsx\n';
            comment += '// ä¾‹: PersonalityCardã®ãƒãƒªã‚¢ãƒ³ãƒˆ\n';
            comment += 'data-testid="personality-card"           // Default\n';
            comment += 'data-testid="personality-card-skeleton"  // Loading\n';
            comment += 'data-testid="personality-card-empty"     // Empty\n';
            comment += 'data-testid="personality-card-error"     // Error\n';
            comment += '```\n\n';
          }

          if (warnings.length > 0) {
            comment += '### âš ï¸ ç¢ºèªãŒå¿…è¦\n\n';
            comment += warnings.join('\n') + '\n\n';
          }

          comment += 'ğŸ“š **å‚è€ƒ**: [ãƒãƒªã‚¢ãƒ³ãƒˆè¨­è¨ˆã‚¬ã‚¤ãƒ‰](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/CLAUDE.md#ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒãƒªã‚¢ãƒ³ãƒˆè¨­è¨ˆ)';

          // PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const existingComment = comments.find(c =>
            c.user.type === 'Bot' && c.body.includes('Variant Check')
          );

          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

          // ãƒãƒªã‚¢ãƒ³ãƒˆä¸è¶³ãŒã‚ã‚‹å ´åˆã¯å¤±æ•—ï¼ˆè­¦å‘Šã®ã¿ã®å ´åˆã¯é€šéï¼‰
          if (issues.length > 0) {
            core.setFailed('Missing required variant data-testids in new UI components.');
          }
