# =====================================================
# CI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆãƒ©ãƒ™ãƒ«é§†å‹•ç‰ˆï¼‰
# PRãƒ»ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ: lint, å‹ãƒã‚§ãƒƒã‚¯, å˜ä½“ãƒ†ã‚¹ãƒˆ, ãƒ“ãƒ«ãƒ‰
#
# ãƒ©ãƒ™ãƒ«ã«ã‚ˆã‚‹åˆ¶å¾¡:
#   ci:skip  - CIã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿å¤‰æ›´æ™‚ï¼‰
#   ci:fast  - lint + å‹ãƒã‚§ãƒƒã‚¯ã®ã¿
#   ci:full  - ãƒ•ãƒ«CIï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
#   ci:e2e   - ãƒ•ãƒ«CI + E2Eãƒ†ã‚¹ãƒˆ
#
# typeåˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ:
#   type:requirements - ci:skipï¼ˆå®Ÿè£…è¨ˆç”»PRã¯ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—ï¼‰
#   type:docs         - ci:skipï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ï¼‰
#   type:implementation/bugfix/refactor - ci:full
# =====================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, labeled, unlabeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NEXT_TELEMETRY_DISABLED: 1

permissions:
  contents: read

jobs:
  # =====================================================
  # ãƒ©ãƒ™ãƒ«ãƒã‚§ãƒƒã‚¯ - CIå®Ÿè¡Œç¯„å›²ã‚’æ±ºå®š
  # =====================================================
  check-labels:
    name: ãƒ©ãƒ™ãƒ«ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    outputs:
      skip_ci: ${{ steps.check.outputs.skip_ci }}
      fast_only: ${{ steps.check.outputs.fast_only }}
      run_e2e: ${{ steps.check.outputs.run_e2e }}
    steps:
      - name: Check CI labels
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request?.labels?.map(l => l.name) || [];
            const isPush = context.eventName === 'push';

            // Push to main/develop ã¯å¸¸ã«ãƒ•ãƒ«CI
            if (isPush) {
              core.setOutput('skip_ci', 'false');
              core.setOutput('fast_only', 'false');
              core.setOutput('run_e2e', 'false');
              core.setOutput('pr_type', 'push');
              console.log('Push event: Full CI');
              return;
            }

            // æ˜ç¤ºçš„ãªci:ãƒ©ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
            const hasCiLabel = labels.some(l => l.startsWith('ci:'));
            const skipCiExplicit = labels.includes('ci:skip');
            const fastOnly = labels.includes('ci:fast');
            const runE2e = labels.includes('ci:e2e');

            // type:ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
            const prType = labels.find(l => l.startsWith('type:'))?.replace('type:', '') || 'unknown';

            // typeåˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCIåˆ¤å®šï¼ˆæ˜ç¤ºçš„ci:ãƒ©ãƒ™ãƒ«ãŒãªã„å ´åˆï¼‰
            let skipCi = skipCiExplicit;
            if (!hasCiLabel) {
              // type:requirements, type:docs ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ci:skip
              if (prType === 'requirements' || prType === 'docs') {
                skipCi = true;
                console.log(`type:${prType} detected, defaulting to ci:skip`);
              }
            }

            core.setOutput('skip_ci', skipCi.toString());
            core.setOutput('fast_only', fastOnly.toString());
            core.setOutput('run_e2e', runE2e.toString());
            core.setOutput('pr_type', prType);

            console.log(`Labels: ${labels.join(', ')}`);
            console.log(`PR Type: ${prType}`);
            console.log(`skip_ci: ${skipCi}, fast_only: ${fastOnly}, run_e2e: ${runE2e}`);

  # =====================================================
  # Lint - ci:skip ä»¥å¤–ã§å®Ÿè¡Œ
  # =====================================================
  lint:
    name: ãƒªãƒ³ãƒˆ
    runs-on: ubuntu-latest
    needs: check-labels
    if: needs.check-labels.outputs.skip_ci != 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-node
      - name: ESLintå®Ÿè¡Œ
        run: npm run lint

  # =====================================================
  # å‹ãƒã‚§ãƒƒã‚¯ - ci:skip ä»¥å¤–ã§å®Ÿè¡Œ
  # =====================================================
  type-check:
    name: å‹ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    needs: check-labels
    if: needs.check-labels.outputs.skip_ci != 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-node
      - name: TypeScriptå‹ãƒã‚§ãƒƒã‚¯
        run: npx tsc --noEmit

  # =====================================================
  # æœªä½¿ç”¨exportæ¤œå‡º - ci:skip, ci:fast ä»¥å¤–ã§å®Ÿè¡Œ
  # =====================================================
  unused-exports:
    name: æœªä½¿ç”¨exportæ¤œå‡º
    runs-on: ubuntu-latest
    needs: check-labels
    if: |
      needs.check-labels.outputs.skip_ci != 'true' &&
      needs.check-labels.outputs.fast_only != 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-node
      - name: æœªä½¿ç”¨exportæ¤œå‡º
        run: npm run check:unused-exports
        # è­¦å‘Šã®ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ã§è½ã¨ã•ãªã„ï¼‰
        continue-on-error: true

  # =====================================================
  # å˜ä½“ãƒ†ã‚¹ãƒˆ - ci:skip, ci:fast ä»¥å¤–ã§å®Ÿè¡Œ
  # =====================================================
  unit-test:
    name: å˜ä½“ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: check-labels
    if: |
      needs.check-labels.outputs.skip_ci != 'true' &&
      needs.check-labels.outputs.fast_only != 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-node
      - name: å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãï¼‰
        run: npm run test:coverage
      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’Codecovã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # =====================================================
  # ãƒ“ãƒ«ãƒ‰ - ci:skip, ci:fast ä»¥å¤–ã§å®Ÿè¡Œ
  # =====================================================
  build:
    name: ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    needs: [check-labels, lint, type-check, unit-test]
    if: |
      needs.check-labels.outputs.skip_ci != 'true' &&
      needs.check-labels.outputs.fast_only != 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-node
      - name: Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v6
        with:
          name: nextjs-build
          path: .next
          retention-days: 1

  # =====================================================
  # CIå®Œäº†ã‚µãƒãƒªãƒ¼
  # =====================================================
  ci-summary:
    name: CIå®Œäº†
    runs-on: ubuntu-latest
    needs: [check-labels, lint, type-check, unused-exports, unit-test, build]
    if: always()
    steps:
      - name: CIã‚µãƒãƒªãƒ¼å‡ºåŠ›
        uses: actions/github-script@v7
        with:
          script: |
            const skipCi = '${{ needs.check-labels.outputs.skip_ci }}' === 'true';
            const fastOnly = '${{ needs.check-labels.outputs.fast_only }}' === 'true';
            const prType = '${{ needs.check-labels.outputs.pr_type }}' || 'unknown';

            let summary = '## CI Summary\n\n';
            summary += `**PR Type:** \`type:${prType}\`\n\n`;

            if (skipCi) {
              if (prType === 'requirements') {
                summary += 'ğŸ“‹ **CI Skipped** (å®Ÿè£…è¨ˆç”»PR - ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—)\n';
                summary += '\n> ğŸ’¡ type:requirements ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ ci:skip ã§ã™ã€‚\n';
                summary += '> æ˜ç¤ºçš„ã« `ci:full` ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã¨ãƒ•ãƒ«CIã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚\n';
              } else if (prType === 'docs') {
                summary += 'ğŸ“ **CI Skipped** (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆPR)\n';
              } else {
                summary += 'â­ï¸ **CI Skipped** (`ci:skip` label)\n';
              }
            } else if (fastOnly) {
              summary += 'âš¡ **Fast CI** (`ci:fast` label)\n';
              summary += '- âœ… Lint\n- âœ… Type Check\n';
              summary += '- â­ï¸ Unit Test (skipped)\n- â­ï¸ Build (skipped)\n';
            } else {
              summary += 'ğŸ”„ **Full CI**\n';
              summary += '- Lint: ${{ needs.lint.result }}\n';
              summary += '- Type Check: ${{ needs.type-check.result }}\n';
              summary += '- Unit Test: ${{ needs.unit-test.result }}\n';
              summary += '- Build: ${{ needs.build.result }}\n';
            }

            console.log(summary);
            core.summary.addRaw(summary).write();
