# =====================================================
# Gold E2Eãƒ†ã‚¹ãƒˆ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# dod:gold ãƒ©ãƒ™ãƒ«é§†å‹•ã§Gold E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
#
# ãƒˆãƒªã‚¬ãƒ¼:
#   - PR: dod:gold ãƒ©ãƒ™ãƒ«ä»˜ä¸æ™‚ã®ã¿å®Ÿè¡Œ
#   - push: mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
#   - schedule: æ¯æ—¥9:00 JST
#   - workflow_dispatch: æ‰‹å‹•å®Ÿè¡Œ
# =====================================================

name: Gold E2Eãƒ†ã‚¹ãƒˆ

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'gold'
        type: choice
        options:
          - gold
          - smoke
  schedule:
    # Run daily at 9:00 JST (0:00 UTC)
    - cron: '0 0 * * *'

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  NEXT_TELEMETRY_DISABLED: 1

permissions:
  contents: read
  pull-requests: write

jobs:
  # =====================================================
  # ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ - å¿…é ˆSecretsã®ç¢ºèª
  # =====================================================
  check-env:
    name: ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    # PRã®å ´åˆ: dod:gold ãƒ©ãƒ™ãƒ«å¿…é ˆ
    # push/schedule/dispatch: å¸¸ã«å®Ÿè¡Œ
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'dod:gold'))
    outputs:
      secrets_valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: å¿…é ˆSecretsç¢ºèª
        id: check
        run: |
          MISSING=""
          if [ -z "${{ secrets.E2E_TEST_EMAIL }}" ]; then
            MISSING="$MISSING E2E_TEST_EMAIL"
          fi
          if [ -z "${{ secrets.E2E_TEST_PASSWORD }}" ]; then
            MISSING="$MISSING E2E_TEST_PASSWORD"
          fi
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" ]; then
            MISSING="$MISSING NEXT_PUBLIC_SUPABASE_URL"
          fi
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" ]; then
            MISSING="$MISSING NEXT_PUBLIC_SUPABASE_ANON_KEY"
          fi

          if [ -n "$MISSING" ]; then
            echo "::error::ä»¥ä¸‹ã®å¿…é ˆSecretsãŒæœªè¨­å®šã§ã™:$MISSING"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "âœ… å…¨ã¦ã®å¿…é ˆSecretsãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"

  # =====================================================
  # Gold E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # =====================================================
  gold-e2e:
    name: Gold E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    needs: check-env
    # check-envã¨åŒã˜æ¡ä»¶ï¼ˆã‚¹ã‚­ãƒƒãƒ—æ™‚ã«cancelledã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'dod:gold'))
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node

      - name: Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npx playwright install --with-deps chromium

      - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Gold E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        id: e2e
        run: |
          if [[ "${{ inputs.test_mode }}" == "smoke" ]]; then
            echo "ğŸ”¥ Running smoke tests only"
            npx playwright test --grep "@smoke" --reporter=list
          else
            echo "ğŸ¥‡ Running Gold E2E tests"
            npx playwright test e2e/gold/ --reporter=list
          fi
        env:
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}
          E2E_BASE_URL: ${{ secrets.E2E_BASE_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: å¤±æ•—æ™‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7

      - name: ãƒ†ã‚¹ãƒˆå¤±æ•—åˆ†æ
        if: failure()
        run: |
          if [ -f "test-results/results.json" ]; then
            echo "## Gold E2Eã‚¨ãƒ©ãƒ¼åˆ†æ" >> $GITHUB_STEP_SUMMARY
            npx tsx scripts/error-detector.ts --github test-results/results.json >> $GITHUB_STEP_SUMMARY || true
          fi

      - name: PRå¤±æ•—é€šçŸ¥ã‚³ãƒ¡ãƒ³ãƒˆ
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âŒ Gold E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ

            ### æ¦‚è¦
            Gold E2Eãƒ†ã‚¹ãƒˆï¼ˆ\`e2e/gold/\`ï¼‰ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

            ### ç¢ºèªæ‰‹é †
            1. [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèª
            2. Artifactsã‹ã‚‰ \`playwright-report\` ã¨ \`playwright-screenshots\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            3. ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ä¿®æ­£ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥

            ### å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆ
            è©³ç´°ã¯ Job Summary ã®ã€ŒGold E2Eã‚¨ãƒ©ãƒ¼åˆ†æã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

            ---
            <sub>ğŸ¤– Gold E2Eãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹è‡ªå‹•é€šçŸ¥</sub>`;

            // æ—¢å­˜ã®å¤±æ•—ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.body.includes('Gold E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ') &&
              c.user.type === 'Bot'
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: PRæˆåŠŸé€šçŸ¥ã‚³ãƒ¡ãƒ³ãƒˆ
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âœ… Gold E2Eãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ

            Gold E2Eãƒ†ã‚¹ãƒˆï¼ˆ\`e2e/gold/\`ï¼‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚

            [ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚

            ---
            <sub>ğŸ¤– Gold E2Eãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹è‡ªå‹•é€šçŸ¥</sub>`;

            // æ—¢å­˜ã®æˆåŠŸ/å¤±æ•—ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã¦å‰Šé™¤
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              (c.body.includes('Gold E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ') || c.body.includes('Gold E2Eãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ')) &&
              c.user.type === 'Bot'
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
