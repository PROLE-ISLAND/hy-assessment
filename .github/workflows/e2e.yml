# =====================================================
# E2Eãƒ†ã‚¹ãƒˆ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Playwright E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
# ãƒˆãƒªã‚¬ãƒ¼: PRï¼ˆã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆï¼‰ã€mainã¸ã®pushã€æ‰‹å‹•å®Ÿè¡Œã€å®šæœŸå®Ÿè¡Œ
# =====================================================

name: E2Eãƒ†ã‚¹ãƒˆ

on:
  pull_request:
    branches: [main]
    # é‡ã„ãƒ†ã‚¹ãƒˆãªã®ã§ã‚³ã‚¢å¤‰æ›´æ™‚ã®ã¿å®Ÿè¡Œ
    paths:
      - 'src/**'
      - 'e2e/**'
      - 'package*.json'
      - 'playwright.config.ts'
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - smoke
  schedule:
    # Run daily at 9:00 JST (0:00 UTC)
    - cron: '0 0 * * *'

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  NEXT_TELEMETRY_DISABLED: 1

permissions:
  contents: read

jobs:
  e2e:
    name: Playwright E2E
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node

      - name: Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npx playwright install --with-deps chromium

      - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          # PRã®å ´åˆã¯ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼ã¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ã¿ï¼‰
          if [[ "${{ github.event_name }}" == "pull_request" ]] || [[ "${{ inputs.test_mode }}" == "smoke" ]]; then
            echo "ðŸ”¥ Running smoke tests only"
            npx playwright test --grep "@smoke" --reporter=list
          else
            echo "ðŸ”¬ Running full E2E tests"
            npm run test:e2e
          fi
        env:
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}
          E2E_BASE_URL: ${{ secrets.E2E_BASE_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: ãƒ†ã‚¹ãƒˆçµæžœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: å¤±æ•—æ™‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7

      - name: ãƒ†ã‚¹ãƒˆå¤±æ•—åˆ†æž
        if: failure()
        run: |
          if [ -f "test-results/results.json" ]; then
            echo "## E2Eã‚¨ãƒ©ãƒ¼åˆ†æž" >> $GITHUB_STEP_SUMMARY
            npx tsx scripts/error-detector.ts --github test-results/results.json >> $GITHUB_STEP_SUMMARY || true
          fi

