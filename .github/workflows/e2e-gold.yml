# =====================================================
# Gold E2Eãƒ†ã‚¹ãƒˆ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# äº‹æ¥­ç¶™ç¶šã«å¿…é ˆã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆ5æœ¬ï¼‰
# ãƒˆãƒªã‚¬ãƒ¼: dod:goldãƒ©ãƒ™ãƒ«PRã€mainã¸ã®push
# å¤±æ•—æ™‚: ãƒžãƒ¼ã‚¸/ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ–ãƒ­ãƒƒã‚¯
# =====================================================

name: Gold E2Eãƒ†ã‚¹ãƒˆ

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: e2e-gold-${{ github.ref }}
  cancel-in-progress: true

env:
  NEXT_TELEMETRY_DISABLED: 1

permissions:
  contents: read
  pull-requests: write

jobs:
  # Gold E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œåˆ¤å®š
  should-run:
    name: å®Ÿè¡Œåˆ¤å®š
    runs-on: ubuntu-latest
    outputs:
      run_gold: ${{ steps.check.outputs.run_gold }}
    steps:
      - id: check
        run: |
          # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã¯å¸¸ã«å®Ÿè¡Œ
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "run_gold=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PRã®å ´åˆã€dod:goldãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            labels='${{ toJSON(github.event.pull_request.labels.*.name) }}'
            if echo "$labels" | grep -q "dod:gold"; then
              echo "run_gold=true" >> $GITHUB_OUTPUT
            else
              echo "run_gold=false" >> $GITHUB_OUTPUT
              echo "::notice::dod:goldãƒ©ãƒ™ãƒ«ãŒãªã„ãŸã‚Gold E2Eã¯ã‚¹ã‚­ãƒƒãƒ—"
            fi
            exit 0
          fi

          # æ‰‹å‹•å®Ÿè¡Œã¯å¸¸ã«å®Ÿè¡Œ
          echo "run_gold=true" >> $GITHUB_OUTPUT

  # Gold E2Eãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— + å…¨6ãƒ†ã‚¹ãƒˆä¸€æ‹¬å®Ÿè¡Œï¼‰
  # Note: ãƒžãƒˆãƒªãƒƒã‚¯ã‚¹å®Ÿè¡Œã§ã¯ãªãä¸€æ‹¬å®Ÿè¡Œã«å¤‰æ›´
  # ç†ç”±: Playwrightã®projectä¾å­˜é–¢ä¿‚ï¼ˆsetup -> chromiumï¼‰ã‚’æ­£ã—ãæ©Ÿèƒ½ã•ã›ã‚‹ãŸã‚
  e2e-gold:
    name: Gold E2Eï¼ˆå…¨6ãƒ†ã‚¹ãƒˆï¼‰
    needs: should-run
    if: needs.should-run.outputs.run_gold == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-node

      - name: Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npx playwright install --with-deps chromium

      - name: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Gold E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå…¨6ãƒ†ã‚¹ãƒˆï¼‰
        run: |
          echo "ðŸ¥‡ Running all Gold E2E tests..."
          echo ""
          echo "ðŸ“‹ ãƒ†ã‚¹ãƒˆä¸€è¦§:"
          echo "  - GS-HY-001: ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³"
          echo "  - GS-HY-002: å€™è£œè€…ç™»éŒ²â†’æ¤œæŸ»ãƒªãƒ³ã‚¯ç™ºè¡Œ"
          echo "  - GS-HY-003: æ¤œæŸ»å›žç­”â†’å®Œäº†"
          echo "  - GS-HY-004: åˆ†æžçµæžœé–²è¦§"
          echo "  - GS-HY-005: ãƒ¬ãƒãƒ¼ãƒˆå…±æœ‰"
          echo "  - GS-HY-006: å€™è£œè€…ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§"
          echo ""
          # èªè¨¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å…ˆã«å®Ÿè¡Œï¼ˆprojectä¾å­˜é–¢ä¿‚ã«ã‚ˆã‚Šè‡ªå‹•ï¼‰
          # --project=chromium ã§èªè¨¼å¿…è¦ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
          # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ dependencies: ['setup'] ã«ã‚ˆã‚Šè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹
          npx playwright test e2e/gold/ --reporter=list
        env:
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}
          E2E_TEST_CANDIDATE_ID: ${{ secrets.E2E_TEST_CANDIDATE_ID }}
          E2E_TEST_ASSESSMENT_TOKEN: ${{ secrets.E2E_TEST_ASSESSMENT_TOKEN }}
          E2E_TEST_REPORT_TOKEN: ${{ secrets.E2E_TEST_REPORT_TOKEN }}
          E2E_BASE_URL: ${{ secrets.E2E_BASE_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: ãƒ†ã‚¹ãƒˆçµæžœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: gold-e2e-report
          path: playwright-report/
          retention-days: 30

      - name: å¤±æ•—æ™‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: gold-e2e-screenshots
          path: test-results/
          retention-days: 7

  # Gold E2Eçµæžœã‚µãƒžãƒªãƒ¼
  gold-summary:
    name: Gold E2Eã‚µãƒžãƒªãƒ¼
    needs: [should-run, e2e-gold]
    if: always() && needs.should-run.outputs.run_gold == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: çµæžœåˆ¤å®š
        run: |
          if [[ "${{ needs.e2e-gold.result }}" == "success" ]]; then
            echo "## ðŸ¥‡ Gold E2Eãƒ†ã‚¹ãƒˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å…¨6æœ¬ã®Gold E2Eãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| ãƒ†ã‚¹ãƒˆ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| GS-HY-001 ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| GS-HY-002 å€™è£œè€…ç™»éŒ² | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| GS-HY-003 æ¤œæŸ»å›žç­”â†’å®Œäº† | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| GS-HY-004 åˆ†æžçµæžœé–²è¦§ | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| GS-HY-005 ãƒ¬ãƒãƒ¼ãƒˆå…±æœ‰ | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| GS-HY-006 å€™è£œè€…ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ | âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸš¨ Gold E2Eãƒ†ã‚¹ãƒˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**äº‹æ¥­ç¶™ç¶šã«å½±éŸ¿ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã¾ã™ã€‚**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### å¯¾å¿œæ‰‹é †" >> $GITHUB_STEP_SUMMARY
            echo "1. å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®ãƒ­ã‚°ã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
            echo "2. ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§å®Ÿéš›ã®ç”»é¢ã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
            echo "3. ä¿®æ­£PRä½œæˆ or ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¤æ–­" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ [Gold Specä»•æ§˜æ›¸](./docs/gold-specs/README.md)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const result = '${{ needs.e2e-gold.result }}';
            const emoji = result === 'success' ? 'ðŸ¥‡' : 'ðŸš¨';
            const status = result === 'success' ? 'æˆåŠŸ' : 'å¤±æ•—';

            const body = `## ${emoji} Gold E2Eãƒ†ã‚¹ãƒˆ ${status}

            | ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
            |-------------|----------|
            | GS-HY-001 ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ | ${result === 'success' ? 'âœ…' : 'â“'} |
            | GS-HY-002 å€™è£œè€…ç™»éŒ² | ${result === 'success' ? 'âœ…' : 'â“'} |
            | GS-HY-003 æ¤œæŸ»å›žç­”â†’å®Œäº† | ${result === 'success' ? 'âœ…' : 'â“'} |
            | GS-HY-004 åˆ†æžçµæžœé–²è¦§ | ${result === 'success' ? 'âœ…' : 'â“'} |
            | GS-HY-005 ãƒ¬ãƒãƒ¼ãƒˆå…±æœ‰ | ${result === 'success' ? 'âœ…' : 'â“'} |
            | GS-HY-006 å€™è£œè€…ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ | ${result === 'success' ? 'âœ…' : 'â“'} |

            ${result !== 'success' ? 'âš ï¸ **ãƒžãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯**: Gold E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã¾ã™ã€‚ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚' : 'âœ… Gold E2Eãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸã€‚'}

            ðŸ“„ [Gold Specä»•æ§˜æ›¸](./docs/gold-specs/README.md)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ã‚¹ã‚­ãƒƒãƒ—æ™‚ã®é€šçŸ¥
  gold-skipped:
    name: Gold E2Eã‚¹ã‚­ãƒƒãƒ—
    needs: should-run
    if: needs.should-run.outputs.run_gold == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: ã‚¹ã‚­ãƒƒãƒ—é€šçŸ¥
        run: |
          echo "## â­ï¸ Gold E2Eãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ã“ã®PRã«ã¯ \`dod:gold\` ãƒ©ãƒ™ãƒ«ãŒãªã„ãŸã‚ã€Gold E2Eãƒ†ã‚¹ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹å“è³ªãŒå¿…è¦ãªå ´åˆã¯ \`dod:gold\` ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
