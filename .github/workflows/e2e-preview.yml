# =====================================================
# E2E Preview テスト ワークフロー
# Vercel Preview デプロイ完了後に E2E テストを実行
# トリガー: Vercel deployment_status success
# =====================================================

name: E2E Preview テスト

on:
  deployment_status:

concurrency:
  group: e2e-preview-${{ github.event.deployment.id }}
  cancel-in-progress: true

env:
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  e2e-preview:
    name: Playwright E2E (Preview)
    # Only run when Vercel deployment succeeds and it's a preview (not production)
    if: |
      github.event.deployment_status.state == 'success' &&
      github.event.deployment_status.environment == 'Preview'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node

      - name: Playwright ブラウザインストール
        run: npx playwright install --with-deps chromium

      - name: E2E テスト実行 (Vercel Preview)
        run: npm run test:e2e
        env:
          # Use Vercel Preview URL as base
          BASE_URL: ${{ github.event.deployment_status.target_url }}
          # Test credentials
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}
          # Skip local webServer (using external URL)
          SKIP_WEB_SERVER: true

      - name: テスト結果をPRにコメント
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const status = '${{ job.status }}';
            const previewUrl = '${{ github.event.deployment_status.target_url }}';

            // Find the PR associated with this deployment
            const deployment = await github.rest.repos.getDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment.id
            });

            const ref = deployment.data.ref;
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${ref}`,
              state: 'open'
            });

            if (prs.data.length === 0) {
              console.log('No open PR found for this deployment');
              return;
            }

            const prNumber = prs.data[0].number;
            const icon = status === 'success' ? '✅' : '❌';

            let body = `## ${icon} E2E テスト結果\n\n`;
            body += `| 項目 | 値 |\n|------|----|\n`;
            body += `| ステータス | ${status === 'success' ? '成功' : '失敗'} |\n`;
            body += `| テスト対象URL | ${previewUrl} |\n`;
            body += `| 実行時間 | ${{ github.run_id }} |\n`;

            if (status !== 'success') {
              body += `\n### 詳細\n`;
              body += `[テストレポートを確認](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: テスト結果アップロード
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-preview
          path: playwright-report/
          retention-days: 7

      - name: 失敗時スクリーンショットアップロード
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots-preview
          path: test-results/
          retention-days: 7
