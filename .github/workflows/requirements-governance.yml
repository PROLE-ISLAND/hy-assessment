# è¦ä»¶å®šç¾©ã‚¬ãƒãƒŠãƒ³ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ–°æ©Ÿèƒ½PRã§é–¢é€£Issueã« requirements-approved ãƒ©ãƒ™ãƒ«ãŒãªã„å ´åˆã«ãƒ–ãƒ­ãƒƒã‚¯
#
# ä½¿ç”¨æ–¹æ³•: å„ãƒªãƒã‚¸ãƒˆãƒªã® .github/workflows/ ã«ã‚³ãƒ”ãƒ¼

name: Requirements Governance

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  check-requirements:
    name: è¦ä»¶å®šç¾©ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: write

    steps:
      - name: PRã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å¤‰æ›´ç¨®åˆ¥ã‚’åˆ¤å®š
        id: check-type
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # è¦ä»¶å®šç¾©ä¸è¦ãªå¤‰æ›´ç¨®åˆ¥
          if [[ "$PR_TITLE" =~ ^(fix|docs|style|refactor|test|chore|ci|deps|perf): ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=å¤‰æ›´ç¨®åˆ¥ãŒè¦ä»¶å®šç¾©ä¸è¦ï¼ˆ$PR_TITLEï¼‰" >> $GITHUB_OUTPUT
          elif [[ "$PR_TITLE" =~ ^feat: ]]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "reason=æ–°æ©Ÿèƒ½ï¼ˆfeatï¼‰ã¯è¦ä»¶å®šç¾©å¿…é ˆ" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "reason=å¤‰æ›´ç¨®åˆ¥ä¸æ˜ã€è¦ä»¶å®šç¾©ãƒã‚§ãƒƒã‚¯å®Ÿæ–½" >> $GITHUB_OUTPUT
          fi

      - name: é–¢é€£Issueã‚’æŠ½å‡º
        if: steps.check-type.outputs.skip == 'false'
        id: extract-issue
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"

          # closes #123, fixes #456, resolves #789 ãªã©ã‚’æŠ½å‡º
          ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oE '(closes|fixes|resolves)\s*#[0-9]+' | grep -oE '[0-9]+' | head -1)

          if [ -z "$ISSUE_NUMBERS" ]; then
            echo "issue_number=" >> $GITHUB_OUTPUT
            echo "has_issue=false" >> $GITHUB_OUTPUT
          else
            echo "issue_number=$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
            echo "has_issue=true" >> $GITHUB_OUTPUT
          fi

      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        if: steps.check-type.outputs.skip == 'false' && steps.extract-issue.outputs.has_issue == 'true'
        uses: actions/checkout@v4

      - name: è©³ç´°è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
        if: steps.check-type.outputs.skip == 'false' && steps.extract-issue.outputs.has_issue == 'true'
        id: check-file
        run: |
          ISSUE_NUMBER="${{ steps.extract-issue.outputs.issue_number }}"
          REQ_FILE="docs/requirements/REQ-${ISSUE_NUMBER}.md"

          if [ -f "$REQ_FILE" ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "file_path=$REQ_FILE" >> $GITHUB_OUTPUT
            echo "file_message=âœ… è©³ç´°è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚ã‚Š: $REQ_FILE" >> $GITHUB_OUTPUT
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "file_path=$REQ_FILE" >> $GITHUB_OUTPUT
            echo "file_message=âŒ è©³ç´°è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ãªã—: $REQ_FILE" >> $GITHUB_OUTPUT
          fi

      - name: Issueãƒ©ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
        if: steps.check-type.outputs.skip == 'false' && steps.extract-issue.outputs.has_issue == 'true'
        id: check-labels
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUMBER="${{ steps.extract-issue.outputs.issue_number }}"
          REPO="${{ github.repository }}"

          # Issueã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
          LABELS=$(gh api repos/$REPO/issues/$ISSUE_NUMBER --jq '.labels[].name' 2>/dev/null || echo "")

          echo "Issue #$ISSUE_NUMBER ã®ãƒ©ãƒ™ãƒ«: $LABELS"

          if echo "$LABELS" | grep -q "requirements-approved"; then
            echo "label_approved=true" >> $GITHUB_OUTPUT
            echo "label_message=âœ… è¦ä»¶å®šç¾©æ‰¿èªæ¸ˆã¿ï¼ˆrequirements-approved ãƒ©ãƒ™ãƒ«ã‚ã‚Šï¼‰" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "no-requirements"; then
            echo "label_approved=true" >> $GITHUB_OUTPUT
            echo "label_message=âœ… è¦ä»¶å®šç¾©ä¸è¦ï¼ˆno-requirements ãƒ©ãƒ™ãƒ«ã‚ã‚Šï¼‰" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "needs-requirements"; then
            echo "label_approved=false" >> $GITHUB_OUTPUT
            echo "label_message=âŒ è¦ä»¶å®šç¾©å¾…ã¡ï¼ˆneeds-requirements ãƒ©ãƒ™ãƒ«ã‚ã‚Šï¼‰" >> $GITHUB_OUTPUT
          else
            echo "label_approved=false" >> $GITHUB_OUTPUT
            echo "label_message=âŒ è¦ä»¶å®šç¾©ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸æ˜ï¼ˆãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ï¼‰" >> $GITHUB_OUTPUT
          fi

          # design-approved ãƒã‚§ãƒƒã‚¯ï¼ˆUIå¤‰æ›´ãŒã‚ã‚‹å ´åˆï¼‰
          if echo "$LABELS" | grep -q "design-approved"; then
            echo "design_approved=true" >> $GITHUB_OUTPUT
            echo "design_message=âœ… ãƒ‡ã‚¶ã‚¤ãƒ³æ‰¿èªæ¸ˆã¿" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "design-review"; then
            echo "design_approved=false" >> $GITHUB_OUTPUT
            echo "design_message=âš ï¸ ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "no-ui"; then
            echo "design_approved=true" >> $GITHUB_OUTPUT
            echo "design_message=âœ… UIå¤‰æ›´ãªã—ï¼ˆno-uiï¼‰" >> $GITHUB_OUTPUT
          else
            echo "design_approved=true" >> $GITHUB_OUTPUT
            echo "design_message=â„¹ï¸ ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ©ãƒ™ãƒ«ãªã—" >> $GITHUB_OUTPUT
          fi

      - name: çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
        if: steps.check-type.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆ
          if [ "${{ steps.extract-issue.outputs.has_issue }}" == "false" ]; then
            COMMENT="## ğŸ” è¦ä»¶å®šç¾©ãƒã‚§ãƒƒã‚¯çµæœ

          âŒ **é–¢é€£IssueãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“**

          PRæœ¬æ–‡ã« \`closes #ç•ªå·\` å½¢å¼ã§Issueã‚’ç´ä»˜ã‘ã¦ãã ã•ã„ã€‚

          **å‚ç…§**: [Issueé§†å‹•é–‹ç™º](https://github.com/PROLE-ISLAND/.github/blob/main/copilot-instructions.md#issueé§†å‹•é–‹ç™º)"
          else
            ISSUE_NUMBER="${{ steps.extract-issue.outputs.issue_number }}"
            FILE_MESSAGE="${{ steps.check-file.outputs.file_message }}"
            LABEL_MESSAGE="${{ steps.check-labels.outputs.label_message }}"
            DESIGN_MESSAGE="${{ steps.check-labels.outputs.design_message }}"

            COMMENT="## ğŸ” è¦ä»¶å®šç¾©ãƒã‚§ãƒƒã‚¯çµæœ

          **é–¢é€£Issue**: #$ISSUE_NUMBER

          ### ãƒã‚§ãƒƒã‚¯é …ç›®

          | é …ç›® | çµæœ |
          |------|------|
          | è©³ç´°è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ« | $FILE_MESSAGE |
          | è¦ä»¶å®šç¾©ãƒ©ãƒ™ãƒ« | $LABEL_MESSAGE |
          | ãƒ‡ã‚¶ã‚¤ãƒ³æ‰¿èª | $DESIGN_MESSAGE |

          **å‚ç…§**:
          - [è¦ä»¶å®šç¾©ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](https://github.com/PROLE-ISLAND/.github/wiki/è¦ä»¶å®šç¾©ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)
          - [V0-Figmaæ´»ç”¨ã‚¬ã‚¤ãƒ‰](https://github.com/PROLE-ISLAND/.github/wiki/V0-Figmaæ´»ç”¨ã‚¬ã‚¤ãƒ‰)
          - [Issueé§†å‹•é–‹ç™º](https://github.com/PROLE-ISLAND/.github/blob/main/copilot-instructions.md#issueé§†å‹•é–‹ç™º)"
          fi

          # æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã—ã¦æ›´æ–°ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
          EXISTING_COMMENT=$(gh api repos/$REPO/issues/$PR_NUMBER/comments --jq '.[] | select(.body | startswith("## ğŸ” è¦ä»¶å®šç¾©ãƒã‚§ãƒƒã‚¯çµæœ")) | .id' | head -1)

          if [ -n "$EXISTING_COMMENT" ]; then
            gh api repos/$REPO/issues/comments/$EXISTING_COMMENT -X PATCH -f body="$COMMENT"
          else
            gh api repos/$REPO/issues/$PR_NUMBER/comments -f body="$COMMENT"
          fi

      - name: è¦ä»¶å®šç¾©æœªæ‰¿èªã®å ´åˆã«å¤±æ•—
        if: steps.check-type.outputs.skip == 'false'
        run: |
          FAILED=false

          if [ "${{ steps.extract-issue.outputs.has_issue }}" == "false" ]; then
            echo "âŒ é–¢é€£IssueãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "PRæœ¬æ–‡ã« 'closes #ç•ªå·' å½¢å¼ã§Issueã‚’ç´ä»˜ã‘ã¦ãã ã•ã„"
            exit 1
          fi

          # è©³ç´°è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
          if [ "${{ steps.check-file.outputs.file_exists }}" != "true" ]; then
            echo "âŒ è©³ç´°è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
            echo "ãƒ‘ã‚¹: ${{ steps.check-file.outputs.file_path }}"
            echo ""
            echo "ã€Stage 2: è©³ç´°è¦ä»¶å®šç¾©ã€‘ã®æ‰‹é †:"
            echo "1. ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¢ãƒƒã‚¯ã®æ‰¿èªã‚’å¾—ã‚‹"
            echo "2. docs/requirements/REQ-{ç•ªå·}.md ã‚’ä½œæˆ"
            echo "3. PRã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒãƒ¼ã‚¸"
            FAILED=true
          fi

          # ãƒ©ãƒ™ãƒ«ãƒã‚§ãƒƒã‚¯
          if [ "${{ steps.check-labels.outputs.label_approved }}" != "true" ]; then
            echo "âŒ è¦ä»¶å®šç¾©ãƒ©ãƒ™ãƒ«ãŒæ‰¿èªã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "${{ steps.check-labels.outputs.label_message }}"
            FAILED=true
          fi

          # ãƒ‡ã‚¶ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ï¼‰
          if [ "${{ steps.check-labels.outputs.design_approved }}" != "true" ]; then
            echo "âš ï¸ ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“"
            echo "${{ steps.check-labels.outputs.design_message }}"
          fi

          if [ "$FAILED" == "true" ]; then
            echo ""
            echo "ã€2æ®µéšè¦ä»¶å®šç¾©ãƒ•ãƒ­ãƒ¼ã€‘"
            echo "Stage 1: ãƒ©ãƒ•è¦ä»¶å®šç¾© + V0ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¢ãƒƒã‚¯ â†’ ãƒ‡ã‚¶ã‚¤ãƒ³æ‰¿èª"
            echo "Stage 2: è©³ç´°è¦ä»¶å®šç¾©MDãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ â†’ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒãƒ¼ã‚¸"
            echo "Stage 3: å®Ÿè£… â†’ PR"
            exit 1
          fi

          echo "âœ… è¦ä»¶å®šç¾©ãƒã‚§ãƒƒã‚¯é€šé"

      - name: ã‚¹ã‚­ãƒƒãƒ—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if: steps.check-type.outputs.skip == 'true'
        run: |
          echo "â„¹ï¸ è¦ä»¶å®šç¾©ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—"
          echo "${{ steps.check-type.outputs.reason }}"
