# 統合DevOpsアーキテクチャ設計書

## 目的ゴール

GitHub中心の開発体制を構築し、以下を実現する：

1. **Issue駆動開発**: GitHub Issueで要件定義 → Claude Codeで開発
2. **フルCD**: テスト通過後、自動本番デプロイ
3. **非機能要件**: セキュリティ・パフォーマンス・品質・ドキュメント自動化
4. **リポジトリ横断**: 複数リポジトリで一貫した開発体制

---

## 1. 統合アーキテクチャ全体像

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         GitHub中心開発体制                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   Issue     │───▶│  Claude     │───▶│    PR       │───▶│   Deploy    │  │
│  │  (要件定義)  │    │   Code      │    │  (レビュー)  │    │  (本番)     │  │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘  │
│        │                  │                  │                  │          │
│        ▼                  ▼                  ▼                  ▼          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    CI/CD Pipeline (GitHub Actions)                   │   │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐  │   │
│  │  │ Lint   │→│ Type   │→│ Unit   │→│ Build  │→│Quality │→│Deploy  │  │   │
│  │  │ Check  │ │ Check  │ │ Test   │ │        │ │ Gate   │ │        │  │   │
│  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│        │                  │                  │                  │          │
│        ▼                  ▼                  ▼                  ▼          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    品質保証レイヤー (Autonomous資産活用)              │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐        │   │
│  │  │ Code       │ │ Error      │ │ Fix        │ │ Report     │        │   │
│  │  │ Quality    │ │ Detector   │ │ Patterns   │ │ Generator  │        │   │
│  │  │ Guardian   │ │            │ │            │ │            │        │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│        │                  │                  │                  │          │
│        ▼                  ▼                  ▼                  ▼          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    非機能要件チェック                                 │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐        │   │
│  │  │ Security   │ │ Performance│ │ Coverage   │ │ Changelog  │        │   │
│  │  │ (Dependabot│ │ (Lighthouse│ │ (Codecov)  │ │ (Release   │        │   │
│  │  │  + audit)  │ │  + Bundle) │ │            │ │  Please)   │        │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. コンポーネント組み合わせの妥当性分析

### 2.1 データフロー整合性

```
┌──────────────────────────────────────────────────────────────────┐
│ Issue → Code → PR → CI → Quality Gate → Deploy                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [Issue作成]                                                     │
│      │ Label: type + priority                                   │
│      │ 受け入れ条件: チェックリスト                               │
│      ▼                                                          │
│  [Claude Code開発]                                               │
│      │ CLAUDE.md 規約参照                                        │
│      │ data-testid 追加                                         │
│      ▼                                                          │
│  [PR作成]                                                        │
│      │ テンプレート使用                                          │
│      │ closes #issue-番号                                       │
│      ▼                                                          │
│  [CI Pipeline] ──────────────────────────────────────┐          │
│      │                                               │          │
│      ├─ ESLint ─────────────────────────────────────▶│          │
│      ├─ TypeScript ─────────────────────────────────▶│ 並列実行  │
│      ├─ Vitest ─────────────────────────────────────▶│          │
│      │                                               │          │
│      ▼                                               ▼          │
│  [Build] ◀───────────────────────────────────────────┘          │
│      │                                                          │
│      ▼                                                          │
│  [Quality Gate] ◀── CodeQualityGuardian                         │
│      │              ErrorDetector                               │
│      │              Coverage閾値                                 │
│      │                                                          │
│      ├─ PASS ──▶ [Deploy] ──▶ [Notify]                          │
│      │                                                          │
│      └─ FAIL ──▶ [Block] + [Report] + [Fix Suggestion]          │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 2.2 コンポーネント間依存関係

| コンポーネント | 入力 | 出力 | 依存先 |
|--------------|------|------|--------|
| **Issue Template** | ユーザー入力 | 構造化Issue | - |
| **PR Template** | 開発者入力 | 構造化PR | Issue |
| **CI Pipeline** | コード変更 | テスト結果 | - |
| **CodeQualityGuardian** | ソースコード | 品質レポート | - |
| **ErrorDetector** | ソースコード + エラーログ | エラー一覧 | - |
| **FixPatterns** | エラー一覧 | 修正提案 | ErrorDetector |
| **ReportGenerator** | 各種メトリクス | 統合レポート | 全コンポーネント |
| **Lighthouse** | ビルド成果物 | パフォーマンススコア | Build完了 |
| **Dependabot** | package.json | セキュリティPR | - |
| **Deploy** | ビルド成果物 | 本番環境 | Quality Gate通過 |

### 2.3 組み合わせ妥当性判定

| 組み合わせ | 妥当性 | 理由 |
|-----------|-------|------|
| CI + CodeQualityGuardian | ✅ 高 | CIの品質チェックステップとして自然に統合 |
| ErrorDetector + FixPatterns | ✅ 高 | 検出→提案の一貫したフロー |
| Lighthouse + Bundle Size | ✅ 高 | パフォーマンス監視の補完関係 |
| ReportGenerator + PR Comment | ✅ 高 | 自動レポートのGitHub統合 |
| Dependabot + Security Scan | ✅ 高 | 依存関係 + コードの二重防御 |
| ContinuousQA + Quality Gate | ✅ 高 | 履歴ベースの回帰検出 |

**競合・重複の懸念**:
| 項目 | 懸念 | 解決策 |
|-----|------|--------|
| ESLint vs CodeQualityGuardian | 一部検出重複 | CQGはESLint対象外パターンに限定 |
| npm audit vs Dependabot | セキュリティ検出重複 | Dependabotを主、auditは補助 |
| Vitest coverage vs Codecov | レポート重複 | Vitestで計測、Codecovで可視化 |

---

## 3. 追加開発が必要なもの

### 3.1 ギャップ分析

```
┌────────────────────────────────────────────────────────────────┐
│                    目的ゴール vs 現状資産                        │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  目的ゴール                    現状資産              ギャップ   │
│  ─────────                    ────────              ────────   │
│  Issue駆動開発                 テンプレートなし        要作成    │
│  Claude Code連携               CLAUDE.md基本のみ     要拡張    │
│  フルCD                        Vercel手動           要自動化   │
│  セキュリティ                   Dependabot設計済み    要実装    │
│  パフォーマンス                 Lighthouse設計済み    要実装    │
│  コード品質                     CQG設計済み          要統合    │
│  ドキュメント自動化             なし                 要新規    │
│  リポジトリ横断                 なし                 要設計    │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 3.2 追加開発項目

#### 必須（目的ゴール達成に不可欠）

| # | 項目 | 内容 | 工数 |
|---|-----|------|-----|
| 1 | **統合オーケストレーター** | 各コンポーネントを連携させるワークフロー | 中 |
| 2 | **Quality Gate判定ロジック** | 複合条件でのデプロイ可否判定 | 小 |
| 3 | **PR Comment統合** | 各ツール結果をPRコメントに集約 | 小 |
| 4 | **エラー→修正提案連携** | ErrorDetector結果をPRコメントで提案 | 中 |
| 5 | **リポジトリ横断設定共有** | Reusable Workflows / Composite Actions | 中 |

#### 推奨（品質向上に有効）

| # | 項目 | 内容 | 工数 |
|---|-----|------|-----|
| 6 | **Changelog自動生成** | Release Please / Conventional Commits | 小 |
| 7 | **品質トレンドダッシュボード** | ContinuousQAのDB + 可視化 | 中 |
| 8 | **E2Eテストデータ自動生成** | シードスクリプト拡張 | 中 |
| 9 | **Slack/Discord通知統合** | デプロイ結果・品質アラート | 小 |

#### 将来検討

| # | 項目 | 内容 | 工数 |
|---|-----|------|-----|
| 10 | **AI駆動コードレビュー** | OpenAI API連携 | 大 |
| 11 | **自動修正適用** | FixEngine統合 | 大 |
| 12 | **予測的品質分析** | 機械学習ベース | 大 |

---

## 4. 統合的に機能運用するために必要なこと

### 4.1 統合レイヤー設計

```
┌─────────────────────────────────────────────────────────────────┐
│                    統合オーケストレーター                         │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    quality-gate.yml                        │  │
│  │                                                            │  │
│  │  jobs:                                                     │  │
│  │    collect-metrics:                                        │  │
│  │      - lint-result                                         │  │
│  │      - test-result                                         │  │
│  │      - coverage-result                                     │  │
│  │      - quality-guardian-result                             │  │
│  │      - lighthouse-result                                   │  │
│  │      - security-result                                     │  │
│  │                                                            │  │
│  │    evaluate-gate:                                          │  │
│  │      - all-tests-pass: required                            │  │
│  │      - coverage >= 70%: required                           │  │
│  │      - no-critical-issues: required                        │  │
│  │      - lighthouse-score >= 80: warning                     │  │
│  │      - no-security-vulnerabilities: required               │  │
│  │                                                            │  │
│  │    decision:                                               │  │
│  │      - DEPLOY: all required pass                           │  │
│  │      - WARN: required pass, warning fail                   │  │
│  │      - BLOCK: any required fail                            │  │
│  │                                                            │  │
│  │    report:                                                 │  │
│  │      - pr-comment: 統合レポート                             │  │
│  │      - slack: 結果通知                                      │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 設定・環境要件

#### GitHub Repository Settings

| 設定 | 値 | 理由 |
|-----|-----|------|
| Branch Protection (main) | Require PR, Require status checks | 直接push防止 |
| Required Status Checks | ci, quality-gate | 品質担保 |
| Require review | 1人以上 | コードレビュー必須 |
| Dismiss stale reviews | ON | 変更後の再レビュー |
| Require conversation resolution | ON | 指摘事項解決必須 |

#### GitHub Secrets

| Secret | 用途 | 必須 |
|--------|------|-----|
| `VERCEL_TOKEN` | Vercel API | ✅ |
| `VERCEL_ORG_ID` | Vercel Organization | ✅ |
| `VERCEL_PROJECT_ID` | Vercel Project | ✅ |
| `CODECOV_TOKEN` | カバレッジ連携 | ✅ |
| `SLACK_WEBHOOK_URL` | 通知 | 推奨 |
| `E2E_TEST_EMAIL` | E2Eテスト | ✅ |
| `E2E_TEST_PASSWORD` | E2Eテスト | ✅ |
| `SUPABASE_URL` | Supabase接続 | ✅ |
| `SUPABASE_ANON_KEY` | Supabase認証 | ✅ |

#### GitHub Environments

| Environment | 用途 | 保護設定 |
|------------|------|---------|
| `staging` | ステージング | なし |
| `production` | 本番 | Required reviewers |

### 4.3 運用プロセス

#### 日次運用

```
┌─────────────────────────────────────────────────────────────┐
│ 09:00  Dependabot PRレビュー                                │
│        - セキュリティ更新の確認・マージ                       │
│                                                             │
│ 随時   Issue対応                                            │
│        - P0/P1: 即時対応                                    │
│        - P2: 今スプリント                                   │
│        - P3: バックログ                                     │
│                                                             │
│ 随時   PR作成・レビュー                                      │
│        - CI通過確認                                         │
│        - Quality Gate確認                                   │
│        - コードレビュー                                      │
│                                                             │
│ 随時   マージ・自動デプロイ                                   │
│        - main マージ → 自動本番デプロイ                      │
│        - Slack通知確認                                      │
└─────────────────────────────────────────────────────────────┘
```

#### 週次運用

```
┌─────────────────────────────────────────────────────────────┐
│ 月曜   品質トレンドレビュー                                   │
│        - ContinuousQA週次レポート確認                        │
│        - 品質低下傾向の早期検出                              │
│                                                             │
│ 金曜   バックログ整理                                        │
│        - P3 Issueのトリアージ                               │
│        - 来週の優先順位決定                                  │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 ドキュメント要件

| ドキュメント | 内容 | 更新タイミング |
|------------|------|--------------|
| **CLAUDE.md** | CI/CD情報、開発フロー追加 | 体制変更時 |
| **CONTRIBUTING.md** | 貢献ガイドライン | 初期作成 |
| **README.md** | プロジェクト概要、セットアップ | 機能追加時 |
| **docs/DEVOPS.md** | DevOps運用ガイド | 体制変更時 |

---

## 5. 実装ロードマップ

### Phase 1: 基盤構築（Week 1-2）

```
┌─────────────────────────────────────────────────────────────┐
│ 目標: CI/CDパイプラインの基本動作                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Week 1:                                                     │
│   [x] .github/workflows/ci.yml 作成                         │
│   [x] .github/actions/setup-node/action.yml 作成            │
│   [x] .github/PULL_REQUEST_TEMPLATE.md 作成                 │
│   [x] .github/ISSUE_TEMPLATE/ 作成                          │
│   [x] .github/dependabot.yml 作成                           │
│                                                             │
│ Week 2:                                                     │
│   [ ] .github/workflows/deploy-production.yml 作成          │
│   [ ] .github/CODEOWNERS 作成                               │
│   [ ] GitHub Branch Protection 設定                         │
│   [ ] Vercel連携設定・Secrets設定                           │
│   [ ] 動作確認テスト                                         │
│                                                             │
│ 成果物: PRマージ → 自動デプロイの基本フロー                   │
└─────────────────────────────────────────────────────────────┘
```

### Phase 2: 品質ゲート導入（Week 3-4）

```
┌─────────────────────────────────────────────────────────────┐
│ 目標: 品質保証レイヤーの統合                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Week 3:                                                     │
│   [ ] CodeQualityGuardian統合（GitHub Actions実行）          │
│   [ ] vitest.config.ts カバレッジ閾値設定                    │
│   [ ] Codecov連携                                           │
│   [ ] .github/workflows/quality-gate.yml 作成               │
│                                                             │
│ Week 4:                                                     │
│   [ ] Lighthouse CI設定                                     │
│   [ ] Bundle Size監視設定                                   │
│   [ ] PR Comment統合（品質レポート自動投稿）                  │
│   [ ] 品質ゲート判定ロジック実装                             │
│                                                             │
│ 成果物: 品質基準未達のPRはマージブロック                      │
└─────────────────────────────────────────────────────────────┘
```

### Phase 3: 非機能要件強化（Week 5-6）

```
┌─────────────────────────────────────────────────────────────┐
│ 目標: セキュリティ・パフォーマンス・ドキュメント自動化          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Week 5:                                                     │
│   [ ] npm audit統合                                         │
│   [ ] ErrorDetector TypeScriptパターン適用                  │
│   [ ] fix_patterns.yaml Next.js拡張                        │
│   [ ] エラー検出→修正提案のPRコメント連携                    │
│                                                             │
│ Week 6:                                                     │
│   [ ] E2Eテストワークフロー設定                              │
│   [ ] E2Eテストデータ自動生成スクリプト                      │
│   [ ] Slack通知統合                                         │
│   [ ] CLAUDE.md CI/CDセクション追加                         │
│                                                             │
│ 成果物: 包括的な非機能要件チェック自動化                      │
└─────────────────────────────────────────────────────────────┘
```

### Phase 4: リポジトリ横断・運用最適化（Week 7-8）

```
┌─────────────────────────────────────────────────────────────┐
│ 目標: 複数リポジトリでの一貫した開発体制                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Week 7:                                                     │
│   [ ] Reusable Workflows作成                                │
│   [ ] Composite Actions共通化                               │
│   [ ] 他リポジトリへの展開                                   │
│   [ ] ContinuousQA導入（品質トレンド）                       │
│                                                             │
│ Week 8:                                                     │
│   [ ] Release Please導入（Changelog自動生成）                │
│   [ ] 運用ドキュメント整備                                   │
│   [ ] チーム向けトレーニング                                 │
│   [ ] 運用開始・振り返り                                     │
│                                                             │
│ 成果物: 複数リポジトリで一貫したDevOps体制                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. リスクと対策

| リスク | 影響 | 対策 |
|-------|------|------|
| CI実行時間が長すぎる | 開発速度低下 | 並列実行、キャッシュ活用、E2Eは夜間実行 |
| Quality Gate誤検出 | 正常PRのブロック | 初期は警告のみ、閾値チューニング後に必須化 |
| CodeQualityGuardian誤報 | 開発者疲弊 | ホワイトリスト機能、パターン調整 |
| Vercelデプロイ失敗 | 本番更新停止 | ロールバック手順整備、ヘルスチェック |
| Secrets漏洩 | セキュリティ侵害 | GitHub Secrets、環境変数の暗号化 |

---

## 7. 成功指標（KPI）

| 指標 | 目標値 | 測定方法 |
|-----|-------|---------|
| CI成功率 | 95%以上 | GitHub Actions統計 |
| 平均CI実行時間 | 5分以内 | GitHub Actions統計 |
| テストカバレッジ | 70%以上 | Codecov |
| Lighthouse Score | 80以上 | Lighthouse CI |
| 本番障害発生率 | 月1件未満 | インシデント記録 |
| PRマージ〜デプロイ時間 | 10分以内 | GitHub Actions統計 |
| 品質スコア | 90以上 | ContinuousQA |

---

## 8. 結論

### 組み合わせの妥当性

**妥当性: 高**

- 各コンポーネント間のデータフローは明確
- 依存関係に循環なし
- 重複は最小限（解決策あり）
- Autonomous資産の7PP非依存部分は有効活用可能

### 追加開発の必要性

**必須5項目**:
1. 統合オーケストレーター（quality-gate.yml）
2. Quality Gate判定ロジック
3. PR Comment統合
4. エラー→修正提案連携
5. リポジトリ横断設定共有

### 統合運用の要件

- GitHub Repository Settings（Branch Protection）
- GitHub Secrets/Environments設定
- 日次/週次運用プロセスの確立
- ドキュメント整備（CLAUDE.md, CONTRIBUTING.md）

### 推奨アプローチ

**段階的導入**:
1. Phase 1-2で基本CI/CDを確立
2. Phase 3-4で品質保証・非機能要件を強化
3. 各Phaseで運用フィードバックを反映

この設計により、GitHub中心の開発体制を有機的に統合し、品質・生産性・セキュリティを同時に向上させることが可能。
